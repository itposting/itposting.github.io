---
title: "왜 RAG가 작동하지 않는지"
description: ""
coverImage: "/assets/img/2024-05-27-WhyYourRAGDoesntWork_0.png"
date: 2024-05-27 14:46
ogImage: 
  url: /assets/img/2024-05-27-WhyYourRAGDoesntWork_0.png
tag: Tech
originalTitle: "Why Your RAG Doesn’t Work"
link: "https://medium.com/@cdg2718/why-your-rag-doesnt-work-9755726dd1e9"
---


## RAG은 아직 유망한 기술이지만, 오늘은 조금 힘든 상황이에요.

무수히 많은 기업들이 Retrieval Augment Generation (RAG) 기술을 실험하고 있지만, 이러한 시스템을 생산 수준으로 구축하는 데 어려움을 겪고 있어요. 이들의 RAG 시스템은 잘 작동하지 않을 뿐만 아니라, 그 원인과 해결 방안을 찾지 못하고 있어요.

지난 몇 달 동안, 수십 개의 인공지능 팀과 전문가들과 대화를 나누었어요. 이 대화와 개인적인 경험을 통해, RAG 시스템을 방해하는 주요 요인은 의미 불일치임을 발견했어요. 즉, 작업의 의도와 RAG의 이해, 그리고 저장된 기본 지식 사이의 불일치입니다. 또한, 벡터 임베딩 기술 자체가 마법 같은 기술이기 때문에 (다소 민감하고 이해하기 어렵기 때문에), 이러한 주요 불일치를 진단하는 것이 어려워져, 생산화의 중요한 장벽이 됩니다.

우리의 목표는 Vanilla RAG가 실패하는 주요 이유를 해소하고, 귀하의 RAG를 생산 단계에 한 발 다가가게 하는 구체적인 전략과 전술을 제시하는 것이에요.

<div class="content-ad"></div>

이 포스트에서는 다음을 다룰 것입니다:

- 이상적인 형태의 RAG의 약속과 바닐라 RAG의 현실을 구별
- 의미 불일치가 어떻게 들어오는지 설명
- 의미 불일치의 진단 및 억제 방법 설명
- RAG 제작에 대한 추가 고수익 전략 소개

(참고: 간편성을 위해 Q&A 텍스트 기반 예제에 중점을 뒀지만, 핵심 아이디어는 다른 사용 사례에도 적용 가능합니다).

# 왜 RAG를 사용해야 하는가?

<div class="content-ad"></div>

RAG (Retrieval Augmented Generation)은 현재 하이프 사이클을 경험하고 있는 패러다임입니다. 명확하고 본질적으로 당신의 인공지능을 위한 검색 엔진인 것 같아요. 예전에 음악가가 되고 싶다고 했던 저로서는 누군가가 이것을 ROCK (Curated Knowledge의 검색?라도 부르는 게 더 좋았을 것 같아요.

RAG는 GPT-3이 대박 히트한 이후 급부상했습니다. LLM(언어모델)을 기반으로 하는 AI를 구축할 때 기업이 직면하는 즉각적인 문제는 GPT와 같은 모델이 그들의 특정 데이터와 도메인에 대해 훈련되지 않았다는 것입니다. 그러나 LLM 전문가들은 빠르게 이를 깨달았습니다. GPT는 비지니스 특화 문맥(예: 지원 문서)이 직접 프롬프트에 제공될 때 놀랄 만큼 잘 작동한다는 것을 발견했습니다. 이는 기업들에게 모델을 세밀하게 조정하는 번거로운 작업에 대한 대안을 제공했습니다.

그리고 RAG가 등장합니다. 원칙적으로, 이것은 인공지능을 위한 특수 검색 엔진입니다. 질문과 함께 사용자 특정 정보를 추가해서 제공하면, GPT를 위한 가장 관련성 높은 문맥을 반환해줍니다.

이론상으로는 좋아보였지만, 실제 생산용 RAG를 만드는 데 중요한 도전이 있었는데, 이를 다음 섹션에서 살펴보겠습니다.

<div class="content-ad"></div>

```markdown
![2024-05-27-WhyYourRAGDoesntWork_0](/assets/img/2024-05-27-WhyYourRAGDoesntWork_0.png)

# RAG Is Promising, Vanilla RAG Is Just the Beginning

RAG is merely a framework, and a perfectly functioning RAG, no matter its backend, would provide enormous value to countless use cases. In this section we provide a pedagogical overview of Vanilla RAG and the underlying workings of semantic search. If you’ve already gone through the mind-bending journey of rationalizing, rejecting, and ultimately embracing the magic of vector embeddings, then feel free to skip this section.

![2024-05-27-WhyYourRAGDoesntWork_1](/assets/img/2024-05-27-WhyYourRAGDoesntWork_1.png)
```  

<div class="content-ad"></div>

이 아이디어들을 더 자세히 살펴봅시다.

벡터 임베딩 모델은 임의의 문자열을 입력하면 고정 차원의 수학적 벡터를 반환합니다. 인기있는 임베딩 모델로는 OpenAI의 텍스트 임베딩 모델인 text-embedding-ada-002와 최신 모델인 text-embedding-3-small이 있습니다. 이러한 모델은 텍스트 덩어리를 ~1500-차원의 벡터로 변환하며 거의 인간이 이해하기 어렵습니다.

![image](/assets/img/2024-05-27-WhyYourRAGDoesntWork_2.png)

벡터는 널리 사용되며 매우 유용한 도구입니다. 왜냐하면 비양적인 요소들을 1) 다양한 차원으로 분해하고, 2) 양적으로 비교할 수 있기 때문입니다. 몇 가지 예시는 다음과 같습니다:

<div class="content-ad"></div>

- (빨강, 초록, 파랑) 색상 팔레트는 각 값이 0부터 255 사이에 있는 벡터입니다.
- Barra와 같은 산업 표준을 이용하면 주식을 넓은 미국 성장, 이자율 변화 등과 같은 경제 요인에 대한 민감도를 양적으로 나타낼 수 있는 벡터로 표현할 수 있습니다.
- Netflix와 같은 플랫폼은 사용자 선호도를 장르 및 기타 기능을 나타내는 요소로 분해할 수 있는 벡터로 표현할 수 있습니다.

코사인 유사도는 의미 검색에서 벡터를 비교하는 데 사용되는 사실상 표준적인 메트릭으로, 두 벡터 사이의 각도에 대한 코사인을 점곱을 통해 적용하는 방식으로 작동합니다. 코사인 값이 1에 가까울수록 벡터가 더 유사합니다. (의미적 유사성을 측정하는 다른 방법도 있지만, 일반적으로 여기에 초점을 맞출 필요가 없습니다. 이 문서에서는 코사인 유사도를 계속 사용할 것입니다).

![이미지](/assets/img/2024-05-27-WhyYourRAGDoesntWork_3.png)

그러나 코사인 유사도와 같은 벡터 비교 메트릭은 절대적인 의미가 없기 때문에 다루기 까다로울 수 있습니다. 값은 완전히 임베딩 모델 및 관련 텍스트의 맥락에 따라 달라집니다. 질문과 답변을 매치시켜 코사인 유사도가 0.73이 나왔다고 가정해 봅시다. 이것이 좋은 일치인가요?

<div class="content-ad"></div>

빠른 예시로 "비란 무엇인가?"라는 질문을 들고, 관련성이 다른 세 가지 텍스트와 비교해 보겠습니다. 아래 표에서 두 가지 다른 OpenAI 모델을 사용한 코사인 유사도의 범위와 해석이 극명하게 다르다는 것을 확인할 수 있습니다. 첫 번째 모델에서 0.73은 완전히 관련 없는 매치를 나타내지만, 두 번째 모델에서는 0.73이 높은 관련성을 나타냅니다. 이는 잘 작동하는 RAG 시스템이 사용하는 이 점수의 의미를 이해하는 것이 필요하다는 것을 보여줍니다.

# 의미 불일치는 문제 발생

바닐라 RAG와 관련된 여러 가지 문제는 의미적 불일치와 임베딩의 낮은 설명력으로 인해 발생할 수 있습니다. 의미적 불일치는 작업의 의도하는 의미, RAG의 그 이해 및 저장된 기본 지식 사이의 불일치를 의미합니다.

<div class="content-ad"></div>

어떻게 작용하는 건가요?

사과와 오렌지를 비교

이는 "질문은 답변과 의미론적으로 같지 않다"라고 대략적으로 말할 수 있으며, 질문과 귀하의 원시 지식 베이스 사이의 직접적인 비교는 그다지 효과적이지 않을 것입니다.

변호사가 수천 개의 문서에서 투자자 사기 증거를 찾아야 할 때를 상상해보세요. "어떤 증거가 Bob이 금융 사기를 저질렀다는 것을 보여줄까요?"라는 질문은 본질적으로 "Bob이 3월 14일에 주식 XYZ를 샀다"와는 의미적 중첩이 없습니다. (거기서 암시적으로 XYZ가 경쟁사이고 3월 14일은 수익 발표 일주 전임).

<div class="content-ad"></div>

벡터 임베딩과 코사인 유사도는 모호합니다

임의 문장의 의미적 내용을 완전히 포착하는 능력에는 벡터의 고유한 불완전성이 있습니다. 다른 섬세한 불완전성은 각 차원이 동등한 위치에 있다고 가정하므로 코사인 유사도가 정확한 순위 매기기 결과를 가져올 것이라고 단정할 수 없다는 것입니다.

실제로 코사인 유사도를 사용한 의미 검색은 방향성은 옳지만 본질적으로 모호합니다. 상위 20개 결과 예측에 유용하지만 최적 답변을 신뢰할 수 있는 순위로 매기기에 단독으로 사용하는 것은 맥락을 고려해야 합니다.

인터넷에서 학습된 임베딩 모델은 당신의 비즈니스와 도메인에 대한 이해가 없습니다.

<div class="content-ad"></div>

저는 Stripe에서 일했었어요. Stripe에는 Connect, Radar, Link와 같은 제품들이 있었죠. 더불어 Direct이라는 단어는 제품에 따라 의미가 매우 다르게 해석되는 경우가 많아서, 직원들 사이에서 심지어 의미론적인 불일치가 눈에 띄었어요. 이는 Stripe 내에서조차 의사소통에 어려움을 줄 수 있다는 것을 의미합니다. 이는 자세히 탐구할 가치가 있는 중요한 주제이며, 별도의 블로그 포스트로 발행할만한 주제입니다.

일반적으로, 의사소통에서 발생하는 의사소통 불일치의 근원은 안정적인 순위에 영향을 미치고 있습니다. 다음 섹션에서는 의사소통 불일치를 진단하고 해결하는 방법에 대해 설명하고, 마지막 섹션에서는 RAG 실행을 개선하기 위한 높은 수익률 전략을 개요로 제시할 것입니다.

# 그림: 의미소통 불일치의 진단 및 억제

이 그림에서는 당신의 RAG에서 완전한 의미 불일치를 진단할 것입니다 - 즉, 비교 결과가 무작위 잡음과 일관성이 없어 신뢰할 수 없을 때입니다. 또한 추가적인 구조를 통해 성능을 향상시키는 조치의 초기 신호를 확인할 것입니다.

<div class="content-ad"></div>

이 예시는 실제 사용 사례에서 나온 내용이지만, 이 블로그 글의 목적을 위해 일부러 단순화했습니다. 이런 식으로 자세하게 설명하면서 주요 포인트를 보여주려는 목적입니다.

설정

(설정의 모든 세부 내용은 구글 Colab 노트북에서 확인할 수 있습니다).

예를 들어, 내부 사용을 위한 RAG를 구축 중인 전자 상거래 스타트업의 사용 사례를 상상해보세요. 주어진 비즈니스 질문에 가장 적합한 SQL 테이블을 찾는 예시 설정을 아래에 보여드립니다. 이 예시의 설정은 다음과 같습니다:

<div class="content-ad"></div>

1) ChatGPT를 사용하여 두 가지 다른 SQL 테이블 스키마를 만들었습니다.

- events.purchase_flow: 제품 흐름 내의 상세하고 원시적인 사용자 이벤트
- aggregates.purchases: 요약 분석을 포함한 롤업된 테이블

2) ChatGPT를 사용하여 몇 가지 가상의 질문을 평가 목적으로 작성했습니다.

- IP 주소가 제품 조회 및 구매 유형에 미치는 영향은 무엇인가요?
- 이 분기 신발 판매의 전반적인 추이는 무엇인가요?
- 시간당 몇 초 이내에 비정상적인 행동이 있나요?
- 뉴이어의 주요 이벤트 주변에 사용자 참여가 어떻게 변화하나요?

<div class="content-ad"></div>

3) ChatGPT를 사용하여 생성된 추가 메타데이터는 다음을 포함합니다.

- 각 테이블의 간단한 설명
- 각 테이블이 독특하게 답변 가능한 샘플 질문들

4) 입력 텍스트를 "garbage"와 비교하여 노이즈가 섞인 코사인 유사도 점수가 어떻게 보이는지 확인했습니다.

5) 랭킹을 위해 네 가지 다른 검색 전략을 비교하여 입력과 "가장 의미론적으로 유사한" 텍스트 유형을 확인했습니다.

<div class="content-ad"></div>

- 전략 1: 테이블 스키마만
- 전략 2: 테이블 스키마 + 간단한 설명
- 전략 3: 테이블 스키마 + 간단한 설명 + 샘플 질문
- 전략 4: 샘플 질문만

잡음이 있는 코사인 유사도 찾기

잡음이 어떤 것인지 직감을 키우기 위해, 우리는 각 질문과 원시 테이블 텍스트 (아래 그림 참조)에 대한 임의의 텍스트 조각들의 코사인 유사도를 비교했습니다. 우리는 쓰레기 입력에 대한 코사인 유사도가 약 0.04-0.23임을 발견했습니다. 아래는 예제 비교입니다:

![이미지](/assets/img/2024-05-27-WhyYourRAGDoesntWork_5.png)

<div class="content-ad"></div>

네! 다시 작성하면 다음과 같습니다.

전략 비교

아래 결과를 보면, 질문을 샘플 질문과만 비교하는 전략 4가 가장 높은 의미적 중첩과 최상의 순위를 보였습니다. 전략 1과 2는 서로 유사하게 수행되었으며 소음에 일관되었습니다. 다시 말해, 비즈니스 질문과 SQL 테이블 문장 간에는 거의 또는 전혀 의미적 중첩이 없었습니다.

이것은 당연한 것일 수 있지만, 비슷한 사과와 오렌지의 비교로 개발된 RAG가 종종 보입니다. 그러나 명백하지 않은 점은 모든 것을 섞는 전략 3이 추가 세부 정보 없이 질문을 분리한 전략 4보다 성능이 나쁘다는 것입니다. 때로는 대망치보다는 메스를 사용하는 것이 낫습니다.

주요 포인트

<div class="content-ad"></div>

요약하자면, 우리는 먼저 코사인 유사성 값의 기준 범위를 구축했습니다. 이 값은 무작위 쓰레기와의 비교를 나타냅니다. 그런 다음 네 가지 다른 검색 전략을 비교했습니다. 개발한 기준을 사용하여 두 전략이 잡음과 일관성이 있는 것으로 보였습니다. 최상의 전략은 비즈니스 질문을 원시 SQL 테이블에 직접 일치시키지 않고 테이블이 답변을 제공하는 예시 비즈니스 질문에 일치시켰습니다.

# RAG을 개선하기 위한 추가 전략

지금까지 표면만 긁어 보았습니다. 여기에 당신의 RAG를 단계적으로 개선할 가치 있는 접근 방법 몇 가지가 있습니다.

데이터를 정리하여 사과와 사과를 비교할 수 있도록 만드는 것

<div class="content-ad"></div>

위의 예시에서 RAG를 개선할 수 있는 추가 구조를 사용할 수 있다는 조짐을 보았습니다. 이는 먼저 질문을 기존 질문 은행에 연결한 후 해당 은행이 올바른 답변을 제시하도록 하는 것을 의미합니다. 이 과정은 질문을 한 번에 올바른 텍스트에 직접 연결하는 것과는 다릅니다.

지원 문서를 기반으로 한 Q&A 시스템에서, 질문→질문 비교가 질문→지원 문서보다 성능을 현저히 향상시킬 수 있다는 것을 발견하실 수 있습니다. 실용적으로는 ChatGPT에 각 지원 문서에 대한 예시 질문을 생성하도록 요청한 후 전문가가 그것들을 검토하도록 할 수 있습니다. 본질적으로 여러분은 직접 Stack Overflow를 사전으로 채우는 것이 될 겁니다.

이 "Stack Overflow" 방법론을 한 단계 더 나아가 볼까요?

- 각 문서에 대해 ChatGPT에게 답변할 수 있는 100개 질문 목록을 생성하도록 요청
- 이러한 질문들은 완벽하지 않을 것이므로 생성된 각 질문마다 올바른 문서와 다른 문서 간의 코사인 유사도를 계산
- 모든 다른 문서에 대해 올바른 문서를 1순위로 선정하도록 랭크될 것으로 예상되는 질문들을 필터링
- 올바른 문서와 두 번째 순위 문서 간의 코사인 유사도 차이가 가장 높은 질문들을 식별하여 가장 높은 품질의 질문들을 정렬
- 인간에게 추가 검토를 요청

<div class="content-ad"></div>

시맨틱 + 관련성 순위 매기기

이것은 당신에게 큰 혜택을 줄 수 있는 중 하나일 수 있습니다. 거의 모든 주요 검색 엔진이 이를 수행합니다. 코사인 유사성은 대략적으로 좋지만, 결국 고도의 랭킹에는 부족함이 있습니다.

다행히도, 귀하의 비즈니스는 AI가 더 나은 결정을 내릴 수 있도록 도울 정보를 더 많이 갖고 있을 수 있습니다. 예를 들어 페이지 뷰 및 좋아요와 같은 메트릭스를 수집해왔을 수도 있으며, 더 나아가 이러한 메트릭스를 페르소나별로 보유하고 있을 수도 있습니다. 사용자/작업 특성을 포함한 다양한 기능을 고려하여 관련성 점수를 만들어 순위를 세밀하게 조정하여 RAG를 훨씬 더 효과적으로 활용할 수 있습니다. 구체적으로, 랭킹을 선형 결합으로 만들 수 있습니다.

rank = (코사인 유사성) + (가중치) x (관련성 점수)

<div class="content-ad"></div>

AI를 사용할 때 쇠사슬이 아니라 면도날을 사용하듯이

수십 년 동안, 소프트웨어 엔지니어링 관행은 많은 작고 엄격하고 명확한 보증을 가진 구성 요소를 선호하는 디자인으로 진화했습니다. 채팅 인터페이스에 대한 열광은 이러한 패러다임을 완전히 뒤집어 놓았고, 5년 후에는 의심의 여지가 있을 수 있습니다.

ChatGPT 및 많은 신흥 생태계가 "어떤 텍스트를 주면 어떤 텍스트를 제공할 것"이라는 패러다임을 장려하고 있습니다. 효능에 대한 보증도 비용과 지연 시간에 대한 보증도 없지만, 대신 이러한 AI들은 "아마도 어느 정도, 때때로 옳을 것"이라는 손으로 만진 약속을 가지고 있습니다. 그러나 비즈니스는 보다 명확하고 주관적인 인터페이스를 제공하여 더 강력한 AI를 구축할 수 있습니다.

분석을 예로 들면, 오늘날 아무도 임의의 데이터 질문을 받아 정확한 SQL 쿼리를 제공하는 약속을 이행하지 못했습니다. 그러나 풀리지 않을 것이라고 낙담하지 말고 여전히 놀랍도록 유용한 기술을 만들 수 있습니다. 예를 들어, 더 명확한 AI는 데이터 과학자가 선별한 SQL 테이블과 템플릿 쿼리의 고정된 데이터 우주에서 사용자들이 검색할 수 있도록 도와줄 수 있습니다. 더 나아가, 대부분의 데이터 중심 비즈니스 질문이 과거에 답변되었기 때문에, 여러분의 AI가 단순히 Slack에서 데이터 질문에 대한 검색 봇일 수도 있습니다.

<div class="content-ad"></div>

# 마무리 말씀

우리는 새로운 AI 시대가 열리고 있습니다. 이번 시대의 새로운 점은 NLP와 언어 모델의 출현이 아니라 Google이 이 분야에 이미 예전부터 참여하고 있었다는 것입니다. 오히려, 중요한 변화는 사용 가능한 기술이 기업들이 자연 언어 기술을 자신들의 특정 사용 사례에 적용하기 위한 진입 장벽을 낮추었다는 것입니다. 하지만 오늘날 이 기술이 아직 초기 개발 단계에 있다는 점을 간과해서는 안 되며, AI에 대한 RAGs를 구축할 때는 지식 베이스 위에 복잡한 검색 엔진을 구축하고 있다는 사실을 명심해야 합니다. 이는 달성 가능하지만, 이러한 문제와 제한 사항을 알고 대응하는 것이 전투의 반도에 해당됩니다.

# 문의

이러한 주제에 대해 더 자세히 논의하고 저희 팀이 도와 줄 수 있는지 확인하려면 언제든지 cdg at ellipticlabs dot ai로 연락해 주세요.