---
title: "N-HiTS  시계열 예측을 위한 딥 러닝을 더 효율적으로 만드는 방법"
description: ""
coverImage: "/assets/img/2024-06-19-N-HiTSMakingDeepLearningforTimeSeriesForecastingMoreEfficient_0.png"
date: 2024-06-19 18:57
ogImage: 
  url: /assets/img/2024-06-19-N-HiTSMakingDeepLearningforTimeSeriesForecastingMoreEfficient_0.png
tag: Tech
originalTitle: "N-HiTS — Making Deep Learning for Time Series Forecasting More Efficient"
link: "https://medium.com/towards-data-science/n-hits-making-deep-learning-for-time-series-forecasting-more-efficient-d00956fc3e93"
---


<img src="/assets/img/2024-06-19-N-HiTSMakingDeepLearningforTimeSeriesForecastingMoreEfficient_0.png" />

2020년에 N-BEATS는 시계열 예측에서 통계적 및 혼합 모델보다 뛰어난 성과를 보인 첫 딥러닝 모델이었습니다.

그 후 2년 뒤인 2022년에 새로운 모델이 N-BEATS를 제쳐놓았습니다. Challu와 Olivares 등이 딥 러닝 모델 N-HiTS를 발표했습니다. 이들은 N-BEATS의 긴 예측 지표에 대한 두 가지 단점을 해결했습니다:

- 정확도의 감소 및
- 계산량의 증가.

<div class="content-ad"></div>

N-HiTS는 시계열 예측을 위한 Neural Hierarchical Interpolation의 약자입니다.

이 모델은 N-BEATS 및 그 신경 기반 확장 아이디어에 기반을 두고 있습니다. 신경 기반 확장은 계층화된 스택을 통해 여러 블록에서 이루어집니다.

이 글에서는 N-HiTS 뒤에 숨겨진 구조, 특히 N-BEATS와의 차이에 대해 살펴볼 것입니다. 하지만 너무 걱정하지 마세요, 깊이 파고들기가 이해하기 쉬울 거에요. 하지만 N-HiTS 작동 방식을 이해하는 것만으로 충분하지 않습니다. 따라서 Python에서 어떻게 N-HiTS 모델을 쉽게 구현하고 하이퍼파라미터를 튜닝할 수 있는지 보여드릴 거에요.

# 핵심 아이디어가 같다면, N-BEATS와 N-HiTS의 차이는 무엇인가요?

<div class="content-ad"></div>

각 모델이 각 스택의 입력과 출력을 처리하는 방식에 차이가 있습니다. N-HiTS의 주요 아이디어는 서로 다른 시간 스케일의 예측을 결합하는 것입니다.

이를 위해 N-HiTS는

- 입력의 다중 속도 데이터 샘플링 및
- 출력의 계층적 보간

을 적용합니다.

이 방법으로 N-HiTS는 더 긴 시계열에 대해 더 나은 정확도와 낮은 계산 비용을 달성합니다.

<div class="content-ad"></div>

다중 비율 데이터 샘플링은 스택이 단기 또는 장기적 영향에 특화되도록 만듭니다. 이러한 스택이 각각의 구성 요소를 학습하기 쉬워집니다. 장기적 행동에 중점을 둔 것은 N-BEATS에 비해 향상된 장기적 시계열 예측을 이끌어냅니다.

계층적 보간은 각 블록이 서로 다른 시간 단위로 예측하도록 허용합니다. 그런 다음 모델은 각 블록의 시간 단위에 맞게 예측을 보간하여 최종 예측과 일치시킵니다. 재샘플링과 보간은 학습 가능한 매개변수의 수를 줄입니다. 이는 훈련 시간이 더 짧고 가벼운 모델로 이어집니다.

이제 N-HiTS가 어떤 점에서 다르게 작동하는지 알았으니, 이러한 변화가 아키텍처에 어떻게 포함되어 있는지 살펴보겠습니다.

# N-HiTS는 자세히 어떻게 작동하나요?

<div class="content-ad"></div>

N-HiTS 모델은 다음과 같은 아키텍처를 가지고 있어요:

![N-HiTS 모델](/assets/img/2024-06-19-N-HiTSMakingDeepLearningforTimeSeriesForecastingMoreEfficient_1.png)

우리가 볼 수 있듯이, N-BEATS와 많은 유사성을 가지고 있어요.

첫째, N-HiTS는 시계열을 lookback 및 forecast 기간으로 분리해요. 둘째, 해당 모델은 다층 스택과 블록으로 구성되어 있어요, backcast와 forecast를 생성해요. 각 블록에서 다층 퍼셉트론은 backcast와 forecast를 위한 기저 확장 계수를 생성해요. backcast는 블록이 포착한 시계열의 일부를 보여줘요. 우리는 이전 블록의 backcast를 제거하고 시계열을 블록에 전달하기 전에요. 이를 통해 각 블록은 서로 다른 패턴을 학습하게 되어요, 블록 간에 잔차만 전달하기 때문이에요. 해당 모델은 모든 블록의 forecast를 합하여 최종 예측을 생성해요.

<div class="content-ad"></div>

유사한 부분에 대해서는 이 정도로 설명을 유지하겠습니다. 더 자세한 정보는 제 N-BEATS 글을 참조하시기 바랍니다.

하지만 차이점에 대해서는 더 깊이 파헤쳐 보겠습니다: 다중 속도 데이터 샘플링과 계층적 보간.

## 입력의 다중 속도 신호 샘플링

N-HiTS는 MaxPool 레이어를 통해 블록 수준에서 다중 속도 샘플링을 수행합니다.

<div class="content-ad"></div>

MaxPool 레이어는 선택된 커널 크기 내에서 가장 큰 값을 취함으로써 입력을 평활화합니다. 따라서 커널 크기가 샘플링 속도를 결정합니다. 커널 크기가 클수록 평활화가 더 강해집니다.

![이미지](/assets/img/2024-06-19-N-HiTSMakingDeepLearningforTimeSeriesForecastingMoreEfficient_2.png)

MaxPool 레이어의 커널 크기는 스택 레벨에서 정의합니다. 따라서 동일한 스택 내의 각 블록은 동일한 커널 크기를 갖습니다.

N-HiTS는 리샘플링을 위해 위에서 아래로 접근하는 방식을 사용합니다. 첫 번째 스택은 큰 커널 크기를 통해 장기적인 효과에 초점을 맞춥니다. 후속 스택은 작은 커널 크기를 통해 단기적인 효과에 초점을 맞춥니다.

<div class="content-ad"></div>

## 출력의 계층 적 보간

N-HiTS는 각 스택의 예측 수, 즉 기수를 줄이기 위해 계층 적 보간을 사용합니다. 더 작은 기수는 장기 예측을 위한 계산 요구 사항을 줄여줍니다.

이게 무슨 말인가요?

시계열의 다음 24시간을 예측하려고 한다고 가정해 봅시다. 우리는 우리 모델이 24개의 예측을 출력할 것을 기대합니다(각 시간당 하나). 시간당 데이터의 다음 두 주를 예측하려면 336개의 예측이 필요합니다(14 * 24). 그게 맞죠?

<div class="content-ad"></div>

그러나 이것이 문제가 되는 곳입니다. N-BEATS 모델을 예를 들어봅시다. 최종 예측은 각 스택의 부분 예측을 결합한 것입니다. 따라서 각 스택은 336개의 값을 예측해야 하며, 이는 계산 비용이 많이 듭니다. N-BEATS는 더 긴 예측 범위에서 같은 문제를 겪는 모델 중 하나에 불과합니다. 다른 딥러닝 접근 방식인 트랜스포머나 순환 신경망과 같은 모델들도 같은 문제에 직면하게 됩니다.

N-HiTS는 각 스택이 서로 다른 시간 스케일에서 예측하도록하여 이 도전을 극복합니다. N-HiTS는 각 스택의 시간 스케일을 내삽을 사용하여 최종 출력에 일치시킵니다.

이를 위해 N-HiTS는 표현 간격 비율 개념을 사용합니다. 이 비율은 예측 기간 내의 예측 수를 결정합니다. 작은 표현 간격 비율은 스택이 더 적은 예측을 하도록 만듭니다. 따라서 스택의 기수가 작아집니다. 예를 들어, 1/2의 표현 간격 비율을 선택합니다. 이는 스택이 최종 예측에서 원하는 매 두 번째 값을 예측하게 만듭니다.

표현 간격 비율은 출력을 입력의 재샘플링과 관련시킵니다. 입력의 재샘플링과 결합되어, 각 스택은 서로 다른 주파수에서 작동합니다. 따라서 각 스택은 서로 다른 속도로 시계열을 처리하는 데 전문화될 수 있습니다.

<div class="content-ad"></div>

N-HiTS의 저자들은 입력에 가까운 스택은 장기적 효과에 초점을 맞춰야 한다고 제안합니다. 따라서 이러한 스택은 표현 비율이 작아야 합니다. 예를 들어, 세 개의 스택을 가질 수 있습니다. 첫 번째 스택은 주간 행동에 특화되어 있고, 두 번째는 일일 행동에 특화되어 있으며, 세 번째는 시간당 행동에 특화되어 있습니다.

![N-HiTS](/assets/img/2024-06-19-N-HiTSMakingDeepLearningforTimeSeriesForecastingMoreEfficient_3.png)

하지만 표현 비율에 대한 합리적인 선택은 무엇인가요?

그것은 시계열에 따라 다릅니다. 저자들은 두 가지 옵션을 권장합니다.

<div class="content-ad"></div>

- 다양한 주파수 범위를 다룰 때 매개변수의 수를 줄이기 위해 스택 간 지수적으로 증가하는 표현 비율을 사용합니다.
- 일간, 주간 등의 시계열 주기를 활용합니다.

# N-HiTS를 활용한 예측 예시

N-HiTS가 어떻게 작동하는지 알게 되었으니, 모델을 예측 작업에 적용해 보겠습니다.

N-BEATS 글에서와 마찬가지로, 우리는 독일의 도매 전기 가격을 다음 두 주 예측할 것입니다. 우리는 CC-BY-4.0 라이선스로 제공되는 "유럽 도매 전기 가격" 데이터를 사용할 것입니다. Nixtla의 neuralforecast 라이브러리에서 N-HiTS 구현을 사용할 것입니다.

<div class="content-ad"></div>

![이미지](/assets/img/2024-06-19-N-HiTSMakingDeepLearningforTimeSeriesForecastingMoreEfficient_4.png)

상세한 데이터 탐색을 하지 않아도 두 가지 계절성 구성 요소를 확인할 수 있습니다:

- 일별: 전기 소비량이 이 시간대에 보통 높기 때문에 아침과 저녁 시간에 가격이 더 높습니다.
- 주간별: 전기 소비량이 평일에 더 높기 때문에 주말보다 평일에 가격이 높습니다.

N-BEATS 논문에서 동일한 데이터 집합을 사용했기 때문에 데이터 준비, 훈련-테스트 분할, 결과 시각화 및 기준 모델에 대한 모든 코드를 재사용할 수 있습니다. 따라서 이곳에 코드 조각을 표시하지 않겠습니다.

<div class="content-ad"></div>

코드 작성에 들어가기 전에 가능한 정확한 예측을 얻으려는 것이 아니라 어떻게 N-HiTS를 적용할 수 있는지를 보여주는 것입니다.

## 베이스라인 모델

하지만, 베이스라인으로 간단한 모델부터 시작해 보겠습니다.

이곳에서는 이전에 N-BEATS 기사에서 사용한 계절성이 있는 단순 모델을 사용할 것입니다. 따라서 자세한 내용은 다루지 않고 결과만 보여드리겠습니다.

<div class="content-ad"></div>

훈련 세트의 마지막 주 데이터를 사용하여 예측하면 MAE가 17.84로 나옵니다. 이미 상당히 좋은 성적입니다.

![이미지](/assets/img/2024-06-19-N-HiTSMakingDeepLearningforTimeSeriesForecastingMoreEfficient_5.png)

## N-HiTS 모델 훈련

첫 번째 N-HiTS 모델을 훈련해 봅시다. Nixtla의 neuralforecast 라이브러리를 사용하므로 구현은 간단합니다. 예측과 과거 기간을 정의하는 N-HiTS 모델을 초기화합니다. 이 경우, 과거 기간을 1주로 설정했습니다.

<div class="content-ad"></div>

그러면 몇 가지 사용자 정의 옵션이 있습니다.

- 모델을 선택하여 스택 및 블록 수, MLP 레이어 크기, 활성화 함수, MaxPooling을 위한 커널 크기, 풀링 유형 등을 사용자 정의할 수 있습니다.
- 손실 함수, 학습률, 배치 크기 등을 선택하여 학습을 사용자 정의할 수 있습니다.
- 입력 데이터의 스케일링을 할 수 있습니다.

Nixtla의 문서 전체 설명을 보십시오.

N-BEATS 모델과 대조적으로 몇 가지 차이점을 볼 수 있습니다. 우리는 모델을 사용자 정의하기 위해 더 많은 매개변수를 가지고 있습니다. 커널 크기 및 풀링 유형을 선택하여 다중 속도 데이터 샘플링을 사용자 정의할 수 있습니다. 계층적 보간은 보간 유형 및 표현성 비율을 통해 사용자 정의할 수 있습니다. 코드 스니펫에서 이미 일부 하이퍼파라미터를 조정해 보았습니다.

<div class="content-ad"></div>

모델을 초기화한 후에는 neuralforecast 클래스로 래핑하고 모델을 적합시킵니다. N-BEATS 기사를 읽으셨다면 이 단계에 익숙할 것입니다.

결과는 기준선보다 더 좋아졌습니다. MAE는 17.84에서 17.01로 낮아졌습니다.

![이미지](/assets/img/2024-06-19-N-HiTSMakingDeepLearningforTimeSeriesForecastingMoreEfficient_6.png)

## N-HiTS 모델의 하이퍼파라미터 튜닝

<div class="content-ad"></div>

좋은 하이퍼파라미터를 찾기 위해 시간을 쓰지 말고 최적화를 실행할 수 있어요.

이것은 복잡하지 않아요. 많은 코드 줄을 추가할 필요가 없습니다. NHITS 모델을 Nixtla의 AutoNHITS 모델로 교체하기만 하면 돼요. AutoNHITS 모델이 하이퍼파라미터 튜닝을 대신 해줍니다. 우리는 백엔드(ray 또는 optuna)와 하이퍼파라미터의 탐색 범위를 선택하기만 하면 돼요.

이 두 가지 선택은 NHITS 모델을 실행하는 것과 달리 유일한 차이점입니다. 다른 모든 단계는 동일합니다.

Optuna를 선택하고 사용자 정의 구성 파일을 사용해 시작해봐요.

<div class="content-ad"></div>

"우리는 '최적화된' N-HiTS 모델이 베이스라인과 N-HiTS 모델에 비해 정확도가 더 낮다는 것을 알 수 있습니다 (MAE는 22.63입니다).

![](/assets/img/2024-06-19-N-HiTSMakingDeepLearningforTimeSeriesForecastingMoreEfficient_7.png)

아마도 저의 검색 공간 선택이 좋지 않았을 수도 있습니다. 따라서 더 많은 시도를 해보거나 더 나은 결과를 얻기 위해 다른 검색 공간을 사용할 수 있습니다. 또는 AutoNHITS의 기본 설정을 사용할 수도 있습니다. 모델에 구성을 전달하지 않고 바로 사용하거나 기본 설정을 약간 변경하여 사용할 수 있습니다.

## 외생 변수가 포함된 N-HiTS"

<div class="content-ad"></div>

이 기사를 마치기 전에 마지막으로 보여드릴것이 있습니다. N-HiTS 모델에서 외생 변수를 사용할 수도 있습니다. 이를 위해 초기화 동안 futr_exog_list로 외생 변수를 NHITS 모델에 전달하기만 하면 됩니다. 예를 들어, 주간 계절성이 있는 경우 모델에 요일을 전달할 수 있습니다.

요일을 외생 변수로 추가한 결과 MAE는 21.62가 나왔습니다. 다양한 외생 변수나 다양한 하이퍼파라미터를 시도하면 정확도를 향상시킬 수 있을 것입니다.

![마지막에 관해](/assets/img/2024-06-19-N-HiTSMakingDeepLearningforTimeSeriesForecastingMoreEfficient_8.png)

# N-HiTS에 대한 마지막 메모

<div class="content-ad"></div>

N-HiTS는 논문에서 다양한 데이터 세트에서 매우 좋은 성능을 보였습니다. 그러나 이것은 모든 문제와 데이터 세트에 대해 N-HiTS가 최적의 해결책이 될 것을 의미하지는 않습니다. 특히 당신의 경우에는요.

예시에서 보듯이, N-HiTS가 단순한 계절성 naive baseline 모델을 거의 이길 수 있었습니다. 하지만 그것에 도달하는 데 시간이 걸렸습니다. 먼저, 모델을 설정하고 좋은 하이퍼파라미터 세트를 찾는 데 더 많은 시간을 소비했습니다. 둘째, 훈련은 기준 모델보다 30배가 넘는 시간이 걸렸습니다.

그래서 이것이 회사 프로젝트였다면, 나는 기준 모델을 선택했을 것입니다. 비록 N-HiTS가 약간의 정확도 향상을 제공하지만, 추가 복잡성은 고생할 가치가 없습니다.

따라서, N-HiTS가 사용하기 쉽고 유망한 모델처럼 보여도, 해당 모델로 프로젝트를 시작하지 마십시오. 간단한 기준 모델로 시작하십시오. 기준을 토대로하여, N-HiTS가 문제에 대한 좋은 선택인지를 결정할 수 있습니다. 예를 들어, N-HiTS가 추가된 복잡성에 비해 얼마나 가치를 더하는지를 고려할 수 있습니다.

<div class="content-ad"></div>

# 결론

이 기사는 매우 길었지만 다뤄야 할 내용이 많았습니다. 여기까지 함께 지켜주셨다면, 이제 다음 내용을 이해하실 수 있을 것입니다.

- N-HiTS 모델이 어떻게 작동하는지에 대해 매우 좋은 이해를 갖게 되었을 것이고,
- N-HiTS가 N-BEATS와 어떻게 다른지를 알게 되었을 것이며,
- 실전에서 N-HiTS 모델을 사용할 수 있을 것이며,
- 하이퍼파라미터 튜닝 중에 모델의 내부 동작을 변경할 수 있을 것입니다.

N-HiTS 모델에 대해 더 깊이 알아보고 싶다면 N-HiTS 논문을 확인해보세요. 그렇지 않다면, 댓글을 남기거나 다음 기사에서 만나요!