{"pageProps":{"post":{"title":"예제와 함께 배우는 Zabbix 외부 검사 방법","description":"","date":"2024-06-22 18:20","slug":"2024-06-22-ZabbixExternalchecksbyexample","content":"\n\n## 샤오미 미지아 센서에서 데이터 가져오기\n\n얼마 전에 샤오미 미지아에서 온도 및 습도 센서를 구입했어요. 정확히 말하면 LYWSD03MMC예요. 빨리 매우 유용하다는 것이 증명되었지만, 측정값을 보기 위해 걸어가야 한다는 것은 상당히 귀찮았어요. 고민거리가 많은 세상이죠.\n\n물론 휴대폰 앱을 사용하거나 샤오미 홈 허브를 구입할 수도 있겠지만, 그런 건 재미가 없잖아요? 대신 내가 이미 가지고 있는 것을 활용하기로 결정했어요 — 제 자신의 자비스 인스턴스. 그래서 여기 있어요.\n\n## 외부 점검\n\n<div class=\"content-ad\"></div>\n\n외부 검사(가끔 \"외부 스크립트\"라고 함)는 에이전트 미리 설치 방식의 모니터링 방법으로, Zabbix 에이전트가 필요하지 않습니다. 대신에 특정 스크립트가 호스트 설정에 따라 서버나 프록시 수준에서 실행됩니다. Zabbix가 스크립트를 실행하고 표준 출력에 표시될 것들을 수집합니다. 종료 코드는 고려되지 않습니다. 이 말은 스크립트가 중요한 것만을 표준 출력에 작성해야 한다는 것을 의미합니다.\n\n## 스크립트 준비\n\n의외로 누군가가 이 센서에서 데이터를 읽을 수 있는 스크립트를 이미 만들어 놓았습니다. GitHub에서 설치 지침과 함께 찾을 수 있지만, 완벽함을 위해 다음 명령어를 실행해야 합니다:\n\n```js\n# apt install python3 bluez python3-pip wget\n# pip3 install bluepy requests\n# wget https://raw.githubusercontent.com/JsBergbau/MiTemperature2/master/LYWSD03MMC.py -O /tmp/LYWSD03MMC.py\n```\n\n<div class=\"content-ad\"></div>\n\n이 단계를 완료한 후에는 스크립트를 적절한 디렉토리에 배치해야 합니다. 정확한 경로는 서버 및 프록시 구성 파일에서 찾을 수있는 ExternalScripts 설정에 따라 다릅니다 (기본적으로 /usr/local/share/zabbix/externalscripts이지만 저는 /usr/lib/zabbix/externalscripts/를 사용하는 경향이 있습니다). External checks는 Zabbix 설치 중에 생성 된 zabbix 사용자로 실행됩니다. 모두 함께 넣어 봅시다.\n\n```js\n# cp /tmp/LYWSD03MMC.py /usr/lib/zabbix/externalscripts/\n# chown zabbix:zabbix /usr/lib/zabbix/externalscripts/*\n# chmod ug+x /usr/lib/zabbix/externalscripts/LYWSD03MMC.py\n```\n\nzabbix 사용자가 어떠한 문제없이 실행할 수 있는지 확인하는 것이 중요합니다. Python 스크립트의 경우 대부분의 경우에 잘 작동하지만 쉘 스크립트의 경우 항상 그렇지는 않습니다. 일부 명령은 상위 권한이 필요할 수 있습니다.\n\n장치의 실제 블루투스 주소로 `BT_MAC`을(를) 대체하는 것이 중요합니다. 찾는 가장 쉬운 방법은 Xiaomi Home 앱을 사용하는 것이며 센서를 등록하여 블루투스 연결을 활성화해야 합니다.\n\n<div class=\"content-ad\"></div>\n\n```js\n# cd /usr/lib/zabbix/externalscripts/\n# sudo -u zabbix ./LYWSD03MMC.py --device <BT_MAC> -c 1\n---------------------------------------------\nMiTemperature2 / ATC Thermometer version 3.1\n---------------------------------------------\n<BT_MAC>에 연결을 시도 중\n온도: 25.01\n습도: 73\n배터리 전압: 2.846 V\n배터리 레벨: 75\n측정값이 1개 수집되었습니다. 잠시 후에 종료됩니다.\n```\n\n위의 단편과 유사한 내용을 확인할 수 있어야 합니다. 만약 실패한다면 문제를 해결하고 나서 진행하십시오. 또 다른 고려해야 할 점은 스크립트가 실행되는 시간입니다. 스크립트 실행 시간을 측정하고 실행 시간보다 약간 더 긴 값으로 Timeout 매개변수를 설정해야 합니다. 기본적으로 Timeout 매개변수는 3초입니다. \n\n```js\n# time ./LYWSD03MMC.py --device <BT_MAC> -c 1\n---------------------------------------------\nMiTemperature2 / ATC Thermometer version 3.1\n---------------------------------------------\n<BT_MAC>에 연결을 시도 중\n온도: 25.0\n습도: 73\n배터리 전압: 2.846 V\n배터리 레벨: 75\n측정값이 1개 수집되었습니다. 잠시 후에 종료됩니다.\n실제    0분 14.956초\n사용자    0분 3.670초\n시스템     0분 0.373초\n```\n\n15초가 걸렸다는 것을 알 수 있습니다. 스크립트가 fluke가 아니라 실행 시간이 실행마다 일관되게 나오는지 확인하기 위해 스크립트를 여러 번 실행하는 것이 좋습니다. 실행 시간이 30초를 넘어가면 최대 Timeout 값이 정확히 30초이므로 운이 좋지 못한 상황입니다. 사용자 정의 Zabbix 설치를 사용할 수 있지만, 스크립트를 최적화하거나 Zabbix 트랩을 사용하는 것이 좋은 해결책입니다.\n\n\n<div class=\"content-ad\"></div>\n\n## 항목 설정\n\n이 작업을 완료하면 템플릿 디자인으로 넘어갈 수 있습니다. 우리의 출력물이 평문인 만큼, 우리는 정규 표현식 전처리를 사용하는 종속 항목을 만들 것입니다. 그러나 먼저 외부 검사 자체를 생성해야 합니다.\n\n![image](/assets/img/2024-06-22-ZabbixExternalchecksbyexample_0.png)\n\n위 그림에서 볼 수 있듯이, 항목 키는 스크립트의 이름과 확장자를 포함합니다. 그런 다음 대괄호 안에는 스크립트에 전달되는 모든 매개변수가 포함됩니다. 해당 데이터는 종속 항목에서 추출될 것이므로 이 항목에 대한 히스토리를 저장하지 않습니다. 예를 들어, 온도 측정 항목은 다음과 같이 구성됩니다.\n\n<div class=\"content-ad\"></div>\n\n`<img src=\"/assets/img/2024-06-22-ZabbixExternalchecksbyexample_1.png\" />`\n\n이 방법으로는 Master 항목에서 모든 데이터를 그대로 복사합니다. 특정 부분만 추출하려면 전처리를 사용해야 합니다. 이 경우 캡처 그룹과 함께 정규식을 사용합니다.\n\n`<img src=\"/assets/img/2024-06-22-ZabbixExternalchecksbyexample_2.png\" />`\n\n# 결론\n\n<div class=\"content-ad\"></div>\n\n이 기사에서는 Zabbix 기능 중 하나인 '외부 체크'에 대해 자세히 살펴보았습니다. 우리가 볼 수 있듯이, 이를 사용하여 다양한 소스에서 데이터를 수집할 수 있습니다. 그러나 지나치게 남용하지 않도록 주의하세요. 이는 Zabbix 성능에 상당한 감소를 일으킬 수 있습니다.\n\n언제든지 궁금한 점이 있으시면 말씀해주세요. 전체 템플릿은 여기서 찾을 수 있습니다.","ogImage":{"url":"/assets/img/2024-06-22-ZabbixExternalchecksbyexample_0.png"},"coverImage":"/assets/img/2024-06-22-ZabbixExternalchecksbyexample_0.png","tag":["Tech"],"readingTime":4},"content":"<!doctype html>\n<html lang=\"en\">\n<head>\n<meta charset=\"utf-8\">\n<meta content=\"width=device-width, initial-scale=1\" name=\"viewport\">\n</head>\n<body>\n<h2>샤오미 미지아 센서에서 데이터 가져오기</h2>\n<p>얼마 전에 샤오미 미지아에서 온도 및 습도 센서를 구입했어요. 정확히 말하면 LYWSD03MMC예요. 빨리 매우 유용하다는 것이 증명되었지만, 측정값을 보기 위해 걸어가야 한다는 것은 상당히 귀찮았어요. 고민거리가 많은 세상이죠.</p>\n<p>물론 휴대폰 앱을 사용하거나 샤오미 홈 허브를 구입할 수도 있겠지만, 그런 건 재미가 없잖아요? 대신 내가 이미 가지고 있는 것을 활용하기로 결정했어요 — 제 자신의 자비스 인스턴스. 그래서 여기 있어요.</p>\n<h2>외부 점검</h2>\n<div class=\"content-ad\"></div>\n<p>외부 검사(가끔 \"외부 스크립트\"라고 함)는 에이전트 미리 설치 방식의 모니터링 방법으로, Zabbix 에이전트가 필요하지 않습니다. 대신에 특정 스크립트가 호스트 설정에 따라 서버나 프록시 수준에서 실행됩니다. Zabbix가 스크립트를 실행하고 표준 출력에 표시될 것들을 수집합니다. 종료 코드는 고려되지 않습니다. 이 말은 스크립트가 중요한 것만을 표준 출력에 작성해야 한다는 것을 의미합니다.</p>\n<h2>스크립트 준비</h2>\n<p>의외로 누군가가 이 센서에서 데이터를 읽을 수 있는 스크립트를 이미 만들어 놓았습니다. GitHub에서 설치 지침과 함께 찾을 수 있지만, 완벽함을 위해 다음 명령어를 실행해야 합니다:</p>\n<pre><code class=\"hljs language-js\"># apt install python3 bluez python3-pip wget\n# pip3 install bluepy requests\n# wget <span class=\"hljs-attr\">https</span>:<span class=\"hljs-comment\">//raw.githubusercontent.com/JsBergbau/MiTemperature2/master/LYWSD03MMC.py -O /tmp/LYWSD03MMC.py</span>\n</code></pre>\n<div class=\"content-ad\"></div>\n<p>이 단계를 완료한 후에는 스크립트를 적절한 디렉토리에 배치해야 합니다. 정확한 경로는 서버 및 프록시 구성 파일에서 찾을 수있는 ExternalScripts 설정에 따라 다릅니다 (기본적으로 /usr/local/share/zabbix/externalscripts이지만 저는 /usr/lib/zabbix/externalscripts/를 사용하는 경향이 있습니다). External checks는 Zabbix 설치 중에 생성 된 zabbix 사용자로 실행됩니다. 모두 함께 넣어 봅시다.</p>\n<pre><code class=\"hljs language-js\"># cp /tmp/<span class=\"hljs-title class_\">LYWSD03MMC</span>.<span class=\"hljs-property\">py</span> /usr/lib/zabbix/externalscripts/\n# chown <span class=\"hljs-attr\">zabbix</span>:zabbix /usr/lib/zabbix/externalscripts<span class=\"hljs-comment\">/*\n# chmod ug+x /usr/lib/zabbix/externalscripts/LYWSD03MMC.py\n</span></code></pre>\n<p>zabbix 사용자가 어떠한 문제없이 실행할 수 있는지 확인하는 것이 중요합니다. Python 스크립트의 경우 대부분의 경우에 잘 작동하지만 쉘 스크립트의 경우 항상 그렇지는 않습니다. 일부 명령은 상위 권한이 필요할 수 있습니다.</p>\n<p>장치의 실제 블루투스 주소로 <code>BT_MAC</code>을(를) 대체하는 것이 중요합니다. 찾는 가장 쉬운 방법은 Xiaomi Home 앱을 사용하는 것이며 센서를 등록하여 블루투스 연결을 활성화해야 합니다.</p>\n<div class=\"content-ad\"></div>\n<pre><code class=\"hljs language-js\"># cd /usr/lib/zabbix/externalscripts/\n# sudo -u zabbix ./<span class=\"hljs-title class_\">LYWSD03MMC</span>.<span class=\"hljs-property\">py</span> --device &#x3C;<span class=\"hljs-variable constant_\">BT_MAC</span>> -c <span class=\"hljs-number\">1</span>\n---------------------------------------------\n<span class=\"hljs-title class_\">MiTemperature2</span> / <span class=\"hljs-variable constant_\">ATC</span> <span class=\"hljs-title class_\">Thermometer</span> version <span class=\"hljs-number\">3.1</span>\n---------------------------------------------\n&#x3C;<span class=\"hljs-variable constant_\">BT_MAC</span>>에 연결을 시도 중\n온도: <span class=\"hljs-number\">25.01</span>\n습도: <span class=\"hljs-number\">73</span>\n배터리 전압: <span class=\"hljs-number\">2.846</span> V\n배터리 레벨: <span class=\"hljs-number\">75</span>\n측정값이 <span class=\"hljs-number\">1</span>개 수집되었습니다. 잠시 후에 종료됩니다.\n</code></pre>\n<p>위의 단편과 유사한 내용을 확인할 수 있어야 합니다. 만약 실패한다면 문제를 해결하고 나서 진행하십시오. 또 다른 고려해야 할 점은 스크립트가 실행되는 시간입니다. 스크립트 실행 시간을 측정하고 실행 시간보다 약간 더 긴 값으로 Timeout 매개변수를 설정해야 합니다. 기본적으로 Timeout 매개변수는 3초입니다.</p>\n<pre><code class=\"hljs language-js\"># time ./<span class=\"hljs-title class_\">LYWSD03MMC</span>.<span class=\"hljs-property\">py</span> --device &#x3C;<span class=\"hljs-variable constant_\">BT_MAC</span>> -c <span class=\"hljs-number\">1</span>\n---------------------------------------------\n<span class=\"hljs-title class_\">MiTemperature2</span> / <span class=\"hljs-variable constant_\">ATC</span> <span class=\"hljs-title class_\">Thermometer</span> version <span class=\"hljs-number\">3.1</span>\n---------------------------------------------\n&#x3C;<span class=\"hljs-variable constant_\">BT_MAC</span>>에 연결을 시도 중\n온도: <span class=\"hljs-number\">25.0</span>\n습도: <span class=\"hljs-number\">73</span>\n배터리 전압: <span class=\"hljs-number\">2.846</span> V\n배터리 레벨: <span class=\"hljs-number\">75</span>\n측정값이 <span class=\"hljs-number\">1</span>개 수집되었습니다. 잠시 후에 종료됩니다.\n실제    <span class=\"hljs-number\">0</span>분 <span class=\"hljs-number\">14.956</span>초\n사용자    <span class=\"hljs-number\">0</span>분 <span class=\"hljs-number\">3.670</span>초\n시스템     <span class=\"hljs-number\">0</span>분 <span class=\"hljs-number\">0.373</span>초\n</code></pre>\n<p>15초가 걸렸다는 것을 알 수 있습니다. 스크립트가 fluke가 아니라 실행 시간이 실행마다 일관되게 나오는지 확인하기 위해 스크립트를 여러 번 실행하는 것이 좋습니다. 실행 시간이 30초를 넘어가면 최대 Timeout 값이 정확히 30초이므로 운이 좋지 못한 상황입니다. 사용자 정의 Zabbix 설치를 사용할 수 있지만, 스크립트를 최적화하거나 Zabbix 트랩을 사용하는 것이 좋은 해결책입니다.</p>\n<div class=\"content-ad\"></div>\n<h2>항목 설정</h2>\n<p>이 작업을 완료하면 템플릿 디자인으로 넘어갈 수 있습니다. 우리의 출력물이 평문인 만큼, 우리는 정규 표현식 전처리를 사용하는 종속 항목을 만들 것입니다. 그러나 먼저 외부 검사 자체를 생성해야 합니다.</p>\n<p><img src=\"/assets/img/2024-06-22-ZabbixExternalchecksbyexample_0.png\" alt=\"image\"></p>\n<p>위 그림에서 볼 수 있듯이, 항목 키는 스크립트의 이름과 확장자를 포함합니다. 그런 다음 대괄호 안에는 스크립트에 전달되는 모든 매개변수가 포함됩니다. 해당 데이터는 종속 항목에서 추출될 것이므로 이 항목에 대한 히스토리를 저장하지 않습니다. 예를 들어, 온도 측정 항목은 다음과 같이 구성됩니다.</p>\n<div class=\"content-ad\"></div>\n<p><code>&#x3C;img src=\"/assets/img/2024-06-22-ZabbixExternalchecksbyexample_1.png\" /></code></p>\n<p>이 방법으로는 Master 항목에서 모든 데이터를 그대로 복사합니다. 특정 부분만 추출하려면 전처리를 사용해야 합니다. 이 경우 캡처 그룹과 함께 정규식을 사용합니다.</p>\n<p><code>&#x3C;img src=\"/assets/img/2024-06-22-ZabbixExternalchecksbyexample_2.png\" /></code></p>\n<h1>결론</h1>\n<div class=\"content-ad\"></div>\n<p>이 기사에서는 Zabbix 기능 중 하나인 '외부 체크'에 대해 자세히 살펴보았습니다. 우리가 볼 수 있듯이, 이를 사용하여 다양한 소스에서 데이터를 수집할 수 있습니다. 그러나 지나치게 남용하지 않도록 주의하세요. 이는 Zabbix 성능에 상당한 감소를 일으킬 수 있습니다.</p>\n<p>언제든지 궁금한 점이 있으시면 말씀해주세요. 전체 템플릿은 여기서 찾을 수 있습니다.</p>\n</body>\n</html>\n"},"__N_SSG":true}